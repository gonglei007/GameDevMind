<h2 align="center">代码重构</h2>
<p>
保持科学、合理的重构，让软件保持高质量。
</p>

**关键词:**<br/>
*代码重构,重构,编码规范,单元测试,代码质量,软件质量,测试驱动开发,TDD*

**标签:**<br/>
*等级: 中级, 阶段: 开发, 分类: 基础能力, 角色: 客户端开发|服务端开发|全栈开发|测试*

----
## 目录

- [代码重构概述](#代码重构概述)
- [重构方法](#重构方法)
- [提炼函数（Extract Function）](#提炼函数extract-function)
- [降低耦合](#降低耦合)
- [消除重复代码](#消除重复代码)
- [移动方法](#移动方法)
- [单元测试](#单元测试)
- [测试模式](#测试模式)
- [Arrange, Act, Assert (AAA Pattern)](#arrange-act-assert-aaa-pattern)
- [结构](#结构)
- [测试驱动开发（TDD）](#测试驱动开发tdd)
- [流程](#流程)
- [编码规范](#编码规范)
- [常见规范](#常见规范)
- [重构工具](#重构工具)
- [工具类型](#工具类型)
- [更多资料](#更多资料)
- [在线书](#在线书)
- [文章资料](#文章资料)

----

## 代码重构概述

**是什么？在哪用？**
- **作用**：在不改变代码外部行为的前提下，改善代码的内部结构，提高代码质量
- **应用场景**：
  - 当代码变得难以维护、理解或扩展时
  - 消除技术债务
  - 提高代码可读性和可维护性
  - 优化代码性能
  - 准备添加新功能前的代码整理

**会遇到哪些问题？用什么解决？**
- **何时需要重构**
  - **问题**：如何判断何时需要重构？
  - **解决方向**：
    - 代码有"坏味道"（Code Smell）：长函数、重复代码、过大的类等
    - 添加新功能困难，需要修改多处代码
    - 代码难以理解，需要大量注释才能看懂
    - 测试难以编写，依赖关系复杂
    - 性能问题，需要优化代码结构

- **安全重构**
  - **问题**：如何安全地进行重构？
  - **解决方向**：
    - 建立完善的测试机制（单元测试、集成测试）
    - 小步重构，每次只做小的改动
    - 使用版本控制，便于回滚
    - 重构前先理解代码，不要盲目重构
    - 使用重构工具（IDE的重构功能）

- **避免引入新bug**
  - **问题**：如何避免重构引入新的bug？
  - **解决方向**：
    - 重构前确保有足够的测试覆盖
    - 重构后运行所有测试
    - 使用自动化测试验证行为不变
    - 代码审查，让其他人检查重构
    - 逐步重构，每次验证后再继续

- **重构时机**
  - **问题**：什么时候重构？是否影响开发进度？
  - **解决方向**：
    - 在添加新功能时顺便重构相关代码
    - 定期安排重构时间（技术债务日）
    - 不要为了重构而重构
    - 平衡重构和功能开发
    - 重构应该是持续的过程，而非一次性大改

**要点和思考方向**
- 重构是持续改进代码质量的过程，不是一次性任务
- 必须有测试支撑，否则重构风险很高
- 小步重构，每次只做小的改动，逐步改善
- 重构不改功能，只改结构
- 在添加新功能时顺便重构，保持代码质量

## 重构方法

**是什么？在哪用？**
- **作用**：提供具体的重构技巧和方法，改善代码结构
- **应用场景**：所有需要改善代码质量的场景

## 提炼函数（Extract Function）

**是什么？在哪用？**
- **作用**：将长函数拆分成多个小函数，提高可读性和可维护性
- **应用场景**：
  - 函数过长（超过20-30行）
  - 函数做了多件事
  - 有重复的代码块

**会遇到哪些问题？用什么解决？**
- **函数粒度**
  - **问题**：函数拆分到什么程度？
  - **解决方向**：
    - 函数应该只做一件事
    - 函数名应该清楚表达函数的作用
    - 避免过度拆分，保持合理的粒度
    - 遵循单一职责原则

**要点和思考方向**
- 长函数难以理解和维护，应该拆分
- 函数名应该清楚表达意图
- 小函数更容易测试和复用

## 降低耦合

**是什么？在哪用？**
- **作用**：减少模块之间的依赖关系，提高代码的模块化程度
- **应用场景**：
  - 模块之间依赖过多
  - 修改一个模块影响其他模块
  - 难以单独测试模块

**会遇到哪些问题？用什么解决？**
- **依赖关系复杂**
  - **问题**：如何识别和简化依赖关系？
  - **解决方向**：
    - 使用依赖注入
    - 引入接口抽象
    - 使用事件/消息机制解耦
    - 遵循依赖倒置原则
    - 使用设计模式（如观察者模式）

**要点和思考方向**
- 高耦合导致代码难以维护和测试
- 使用接口和抽象降低耦合
- 依赖注入是降低耦合的有效方法

## 消除重复代码

**是什么？在哪用？**
- **作用**：消除重复的代码，提高代码复用性
- **应用场景**：
  - 发现重复的代码块
  - 多个地方有相似的逻辑
  - 复制粘贴的代码

**会遇到哪些问题？用什么解决？**
- **过度抽象**
  - **问题**：如何避免过度抽象？
  - **解决方向**：
    - 只在真正需要时抽象
    - 遵循"三次原则"（出现三次再抽象）
    - 保持抽象的简单性
    - 不要为了复用而过度设计

**要点和思考方向**
- 重复代码是维护的噩梦
- 适度抽象，避免过度设计
- 使用函数、类、模板等消除重复

## 移动方法

**是什么？在哪用？**
- **作用**：将方法放到合适的类中，遵循单一职责原则
- **应用场景**：
  - 方法不属于当前类
  - 方法被其他类频繁使用
  - 类的职责不清晰

**会遇到哪些问题？用什么解决？**
- **职责划分**
  - **问题**：如何判断方法应该属于哪个类？
  - **解决方向**：
    - 遵循单一职责原则
    - 方法应该操作类的数据
    - 考虑方法的调用者
    - 使用领域驱动设计（DDD）的思想

**要点和思考方向**
- 方法应该放在最合适的类中
- 遵循单一职责原则
- 考虑方法的职责和调用关系

## 单元测试

**是什么？在哪用？**
- **作用**：测试代码的最小单元（函数、方法），验证代码行为是否符合预期
- **应用场景**：
  - 重构的安全网
  - 验证代码正确性
  - 防止回归错误
  - 文档化代码行为

**会遇到哪些问题？用什么解决？**
- **测试覆盖不足**
  - **问题**：如何确保测试覆盖足够？
  - **解决方向**：
    - 使用代码覆盖率工具
    - 测试边界条件和异常情况
    - 测试关键路径和业务逻辑
    - 定期审查测试覆盖
    - 不要只追求覆盖率，要关注测试质量

- **测试难以编写**
  - **问题**：代码难以测试，依赖复杂
  - **解决方向**：
    - 使用依赖注入
    - 使用Mock对象
    - 降低耦合，提高可测试性
    - 使用测试框架和工具
    - 重构代码使其更易测试

- **测试维护成本**
  - **问题**：测试代码也需要维护，成本高
  - **解决方向**：
    - 保持测试代码简洁
    - 使用测试工具和框架
    - 定期重构测试代码
    - 测试应该比被测试代码更简单
    - 使用测试数据构建器

## 测试模式

## Arrange, Act, Assert (AAA Pattern)

**是什么？在哪用？**
- **作用**：测试的标准结构模式，提高测试可读性
- **应用场景**：所有单元测试

## 结构

- **Arrange（准备）**：准备测试数据和环境
- **Act（执行）**：执行被测试的代码
- **Assert（断言）**：验证结果是否符合预期

**要点和思考方向**
- AAA模式让测试结构清晰
- 每个测试应该只测试一件事
- 测试应该独立，不依赖其他测试

**要点和思考方向**
- 单元测试是重构的安全网
- 没有测试的重构风险很高
- 测试应该简单、快速、独立
- 使用AAA模式组织测试代码

## 测试驱动开发（TDD）

**是什么？在哪用？**
- **作用**：先写测试，再写实现，通过测试驱动开发
- **应用场景**：
  - 需要明确需求
  - 需要高质量代码
  - 需要快速反馈

## 流程

1. **Red**：写一个失败的测试
2. **Green**：写最简单的实现让测试通过
3. **Refactor**：重构代码，保持测试通过

**会遇到哪些问题？用什么解决？**
- **学习曲线**
  - **问题**：TDD需要改变开发习惯
  - **解决方向**：
    - 从小项目开始练习
    - 理解TDD的价值
    - 逐步采用，不要强制
    - 团队一起学习

- **时间成本**
  - **问题**：写测试需要额外时间
  - **解决方向**：
    - 长期来看，TDD节省时间
    - 减少调试时间
    - 减少重构风险
    - 提高代码质量

**要点和思考方向**
- TDD帮助明确需求和设计
- 先写测试可以提前发现问题
- TDD需要实践和习惯
- 不是所有场景都适合TDD

## 编码规范

**是什么？在哪用？**
- **作用**：定义代码编写的一致性和标准，确保团队成员编写的代码风格统一
- **应用场景**：
  - 所有代码编写场景
  - 多人协作的项目
  - 代码审查

**会遇到哪些问题？用什么解决？**
- **规范制定**
  - **问题**：如何制定适合团队的编码规范？
  - **解决方向**：
    - 参考行业标准（如Google风格指南）
    - 根据团队实际情况调整
    - 团队讨论达成共识
    - 使用自动化工具检查
    - 定期更新规范

- **规范执行**
  - **问题**：如何确保团队成员遵守编码规范？
  - **解决方向**：
    - 使用代码格式化工具（如Prettier、clang-format）
    - 集成到CI/CD流程
    - 代码审查时检查
    - 提供规范和工具文档
    - 新成员入职培训

- **规范平衡**
  - **问题**：如何平衡规范性和灵活性？
  - **解决方向**：
    - 核心规范必须遵守
    - 允许团队自定义部分规范
    - 定期审查和调整
    - 避免过度规范

## 常见规范

- **命名规范**：变量、函数、类等的命名约定
- **注释规范**：注释的格式、内容和位置
- **代码结构**：函数长度、类的大小等
- **标识符使用**：全局变量、静态变量等的使用规范

**要点和思考方向**
- 编码规范提高代码可读性和质量
- 使用工具自动检查和格式化
- 规范应该简洁实用，不要过度
- 团队共识很重要

## 重构工具

**是什么？在哪用？**
- **作用**：提供自动化重构功能，提高重构效率和安全性
- **应用场景**：所有重构工作

## 工具类型

- **IDE重构工具**：重命名、提取函数、移动方法等
- **静态分析工具**：检测代码问题
- **代码格式化工具**：统一代码风格

**要点和思考方向**
- 使用工具可以安全高效地重构
- 理解工具的行为，不要盲目使用
- 工具不能替代对代码的理解

## 图谱

## 更多资料
## 在线书
* [Unit Testing](https://livebook.manning.com/book/unit-testing/about-this-book/)
* [A Basic Introduction To C# Unit Test For Beginners](https://www.c-sharpcorner.com/article/a-basic-introduction-of-unit-test-for-beginners/)
* [Unity Unit Testing Basics Tutorial (C#, NUnit)](https://letsmakeagame.net/unity-unit-testing-basics-tutorial/)
* [Unity Unit Testing Advanced Tutorial – CI, Patterns, IDE Support & More](https://letsmakeagame.net/unity-unit-testing-advanced-tutorial/)
## 文章资料
* [从代码质量谈重构与设计模式](https://zhuanlan.zhihu.com/p/597658248)