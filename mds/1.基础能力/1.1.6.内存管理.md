<h2 align="center">内存管理</h2>
<p>
当开始考虑系统的运行效率、稳定性的时候，内存管理就是一个不得不认真去考虑的事情。
</p>

**关键词:**<br/>
*内存对齐,GC,内存池,静态内存,动态内存,局部变量*

----
## 为什么要关注内存？

### 是什么？在哪用？

- **重要性**：内存是一个重要资源，合理的使用内存，可以让程序高效、稳定
- **应用场景**：所有需要高性能和稳定性的程序都需要关注内存管理

## 问题

### 会遇到哪些问题？

- **服务端程序内存泄漏**
  - **问题**：服务端程序的内存持续泄漏，最后让系统内存不足，分配不出来新的内存，服务端崩溃
  - **影响**：系统不稳定，服务中断

- **客户端性能问题**
  - **问题**：客户端的loop中有大量的内存分配、释放，造成程序的FPS降低
  - **影响**：用户体验下降，游戏卡顿

## 内存池

### 是什么？在哪用？

- **作用**：避免频繁的分配释放内存，产生碎片。影响内存使用效率，并且降低运行效率
  - **分配释放内存，效率低**：频繁的内存分配和释放操作本身就有性能开销
  - **访问不连续内存，效率低**：内存碎片导致访问不连续，影响CPU缓存效率

### 实践

- **内存预算**：为各个功能系统预设好内存用量预算
- **应用场景**：需要频繁分配释放内存的场景，如游戏中的对象池、粒子系统等

## 内存使用效率

### 是什么？在哪用？

- **内存对齐**：按照CPU访问要求对齐内存，提高访问效率
- **内存连续**：保持内存的连续性，提高缓存命中率

### 影响

- **速度**：影响CPU访问内存的速度
  - 对齐和连续的内存访问更快
  - 不连续的内存访问会导致缓存未命中，性能下降

- **尺寸**：影响内存使用的尺寸
  - 内存对齐可能会增加一些内存开销
  - 但能显著提高访问速度

## 局部变量

### 是什么？在哪用？

- **特点**：分配在栈上
- **生命期**：函数调用时创建和销毁
- **优势**：分配和释放速度快，自动管理
- **限制**：栈空间有限，不适合大对象

## 静态内存

### 是什么？在哪用？

- **特点**：
  - **分配位置**：分配在全局数据区域
    - 有大小限制
    - 包含：全局变量、静态变量和常量
  - **固定大小**：编译期大小就确定了
  - **速度较快**：访问速度快
  - **冗余使用**：可能造成内存浪费

- **生命期**：生命周期与整个程序运行时间相关

### 应用

- **高性能场景**：当需要高性能运行程序的时候，这部分程序所用的内存推荐使用静态内存
- **适用场景**：固定大小的数据结构、常量数据等

## 动态内存

### 是什么？在哪用？

- **特点**：
  - **分配位置**：在堆（Heap）上分配
  - **按需分配**：运行时根据需要分配
  - **灵活**：运行时动态调整内存的分配和释放

- **生命期**：
  - 开发者控制
  - 运行时确定
  - 例如C++，new时分配，delete时释放

### 会遇到哪些问题？

- **内存泄漏**：忘记释放内存导致内存泄漏
- **野指针**：释放后继续使用导致程序崩溃
- **碎片化**：频繁分配释放导致内存碎片

## GC（垃圾回收）

### 是什么？在哪用？

- **作用**：对于高级语言，有垃圾回收机制，自动管理内存

### 会遇到哪些问题？

- **性能问题**
  - **问题**：依然不能随便的使用内存，错误的使用，还是会造成性能或者泄漏问题
  - **解决方向**：合理使用内存，避免不必要的对象创建，注意循环引用等

### 算法

- **复制算法（Copying GC）**
  - **结构**：使用两个堆空间，From空间用于分配内存，To空间用于转移活跃对象
  - **特点**：速度快，但内存利用率低（需要两倍空间）

- **标记清除（Mark-Sweep GC）**
  - **结构**：多条链表及树形链表
  - **分配策略**：best-fit
  - **特点**：
    - 内存利用率高
    - 内存碎片化严重

- **标记压缩（Mark-Compact GC）**
  - **特点**：
    - 效率相对低
    - 内存连续

- **分代收集算法**
  - **原理**：根据对象的生命周期采用不同的回收策略
  - **目标**：优化垃圾回收性能，减少回收的成本
  - **特点**：
    - 针对不同生命周期的对象采用不同的回收策略，提高了回收效率
    - 避免了全堆扫描，减少了垃圾回收的停顿时间
    - 延迟了老年代的回收，降低了回收的频率

## 游戏开发中的应用

### 是什么？在哪用？

- **内存规划**：在游戏开发中，内存的使用相对明确，就是说可以预先规划
  - **内存预算**：比如各大系统的内存预算是多少
  - **预留策略**：有哪些可以预先分批（预留），预留多少
  - **动态分配**：有哪些是动态分配、释放的

- **方案选择**：这样就可以选择内存尽量连续、使用和执行效率高的内存管理方案。当然，也可以针对不同的系统使用不同的方案

- **实践建议**：
  - 为不同系统制定内存预算
  - 使用内存池管理频繁分配释放的对象
  - 静态内存用于固定大小的数据结构
  - 动态内存用于运行时不确定大小的数据

## 更多资料

### 问答资料
* [如何设计内存池？](https://www.zhihu.com/question/25527491/answer/2629173868)
