<h2 align="center">客户端优化</h2>
<p>
现在的游戏都在追求极致表现和体验，这就需要做一系列的工作去"压榨"各种资源。客户端优化涉及性能、内存、包体、耗电、网络、加载等多个方面，每个方面都需要系统性的优化策略。
</p>

**关键词:** <br/> 
*客户端优化,优化,FPS,帧率,Profiler,性能优化,包体优化,耗电优化,网络优化,内存优化,加载优化,CPU优化,GPU优化,Graphics优化,Draw Call,Draw Primitive,线程优化,指令集优化,数学优化,sqrt,三角面优化,贴图优化,材质优化,视距,特效优化,渲染管线,Shader优化,Sampler,IO优化,Unity Profiler,UWA,GOT,性能保障,性能监控,数据序列化,延迟后台加载,aab包,延迟更新,资源压缩,贴图压缩,声音压缩,模型压缩,内存预算,系统内存预算,内存监控*

**标签:**<br/>
*等级: 中级|高级, 阶段: 优化, 分类: 研发能力, 角色: 客户端开发*

## 图谱
![图片加载中...](../../exports/3.1.3.客户端优化.png?raw=true)

## 优化概览

### 性能优化

**做什么的？** 提升游戏运行性能，确保流畅的游戏体验。

**在哪用？** 所有游戏项目，特别是对性能要求高的游戏。

**会遇到哪些问题？**
- 如何确保游戏帧率稳定？
- 如何优化 CPU 和 GPU 性能？
- 如何做好性能保障和监控？

**要点和思考方向：**

**优化目标：**
- 至少 20 多 FPS 才能让画面看上去不难受
- 不同游戏类型对帧率要求不同，需要根据实际情况设定目标

**性能保障方案：**
- **概述：** 事后发现问题、解决问题，代价总是很高的。尽量做好日常保障，并且能第一时间发现问题。
- **方法：**
  - 在程序设计和实现的时候，就考虑到性能优化
  - 在数字内容制作之前，尽量约定好规格
  - 每日构建和测试版本，记录性能指标。发现问题第一时间去找到和处理

**CPU 优化：**
- **Draw Primitive/Draw Call：** 数量决定 CPU 的负担
  - 尽可能的去合并可合并的模型
  - 注意：平衡好模型合并和可见性裁剪的关系
- **线程：** 检查是否有线程之间的等待，检查网络是否在独立的线程中操作
- **指令集：** 使用合适的指令集优化
- **数学优化：**
  - **sqrt：** 网络上可以搜到快速 Sqrt 的算法，如果精度能满足，就用那个
  - **化简或者预计算：** 有些高消耗的计算，如果可以预先把计算方法化简，或者预先可以知道结果，就预先做好公式简化或者替 CPU 算好
- **程序代码优化：**
  - **空间换时间：** 有些数据如果可以预先存在内存的，就不要在运行时算出来
  - **预先算出结果：** 有些公式如果预先可以算出结果的，就不要在运行时去运算

**Graphics 优化：**
- **三角面：**
  - 在保证效果的情况下，尽量减少模型面数
  - 通过可见性控制，降低同屏三角面数量
  - LOD（细节层次）优化
- **贴图：**
  - 平衡好贴图尺寸和清晰度
  - 生成 mipmap
  - 组织分配好图片元素的图集
  - 让贴图尺寸是 2 的幂
  - 压缩贴图
- **材质：**
  - 考虑 shader 的复杂度对性能的影响
  - 控制好半透明物体数量
- **视距：** 调整好摄像机远截面的距离
- **特效：** 控制好粒子数量
- **渲染管线/Shader：**
  - 减少 Sampler 函数
  - 如果能预先算好，就尽量减少一些数学函数的调用（如 sqrt、三角函数等）
  - 控制好数据运算精度
  - 能在 vs 中处理的，尽量不在 ps 中处理

**IO 优化：**
- IO 操作是性能较低的操作，尽量不要在 Update 中频繁的操作 IO
- **检查：**
  - 是否有频繁的读写文件 IO
  - 是否有频繁的内存分配和释放

### 优化工具

**做什么的？** 用于分析和定位性能问题的工具。

**在哪用？** 性能优化和问题排查阶段。

**要点和思考方向：**

**Unity 引擎：**
- **自带的 Profiler：**
  - Code Profiler（代码性能分析）
  - Render Profiler（渲染性能分析）
  - Network Profiler（网络性能分析）
  - Memory Profiler（内存分析）
  - Physics Profiler（物理性能分析）
- **第三方：**
  - **UWA：**
    - GOT Local（本地性能分析）
    - GOT Online（在线性能分析）
    - 线上测评
    - 线下深度优化

**Unreal 引擎：**
- 自带的 Profiler

**程序代码：**
- **Profiler 工具举例：**
  - C++ Profiler
  - gprof

### 网络优化

**做什么的？** 优化网络通信性能，减少延迟和流量消耗。

**在哪用？** 所有需要网络通信的游戏。

**要点和思考方向：**
- **多线程：** 在独立线程中工作，避免让 UI 卡顿
- **消息压缩：**
  - **Protobuf：**
    - 利：压缩更高效
    - 弊：开发效率稍低
  - **JSON+gzip：**
    - 利：开发很便利
    - 弊：压缩效率和执行效率相对较低

### 加载优化

**做什么的？** 提高数据加载速度，让玩家尽快开始体验游戏。

**在哪用？** 游戏启动、场景切换、资源加载等场景。

**要点和思考方向：**
- **数据序列化：** 加载到内存直接使用数据，不需要再对数据进行解析、组织等操作
- **延迟后台加载：** 非关键资源可以在后台异步加载

### 包体优化

**做什么的？** 减小游戏安装包大小，提高下载转化率。

**在哪用？** 游戏发布和分发阶段。

**要点和思考方向：**
- **aab 包：** 上架 Google Play 的包的一种优化方案
- **延迟更新/下载：** 有些后期会用到的游戏内容，在游戏玩到一定阶段，触发后台下载
- **资源压缩：**
  - **贴图压缩：** 使用压缩格式
  - **声音压缩：**
    - 降低码率
    - 降低采样率
    - 使用压缩格式
  - **模型压缩：**
    - 优化面数
    - 优化顶点数据的位数

### 耗电优化

**做什么的？** 降低游戏功耗，延长设备续航时间。

**在哪用？** 移动设备游戏，特别是需要长时间运行的游戏。

**要点和思考方向：**
- **优化 IO：** 内存、文件、网络
- **优化 CPU：** 减少不必要的计算
- **优化渲染：** 降低渲染负载

### 内存优化

**做什么的？** 优化内存使用，提高设备适配性。

**在哪用？** 所有游戏项目，特别是移动设备游戏。

**会遇到哪些问题？**
- 如何做好资源内存预算？
- 如何做好系统内存预算？
- 如何做好内存监控？

**要点和思考方向：**
- **作用：** 更少的内存使用将获得更大的设备适配性
- **做好资源内存预算：**
  - **举例：** 贴图、模型、音效、游戏对象
  - **方法：** 在游戏或系统设计的前期，程序、美术共同对各种资源的使用量做个初步规划
- **做好系统内存预算：** 尽量为各个系统预先分配好内存
- **做好内存监控：**
  - 在开发的过程中，监控好内存的变化。在开发的前期，可能会超预算的使用，不过在后期就要开始寻找可优化的内容
  - 使用 Profiler 工具进行持续的记录

## 更多资料
* [Code Optimizations for Game Development: Basic Structures and Mindsets](https://gamedevelopment.tutsplus.com/tutorials/code-optimizations-for-game-development-basic-structures-and-mindsets--cms-30760)
* [Research on the 3D Game Scene Optimization of Mobile Phone Based on the Unity 3D Engine](https://ieeexplore.ieee.org/abstract/document/6086340)
* [Game Assets (Graphics) Optimization](https://www.theappguruz.com/blog/game-assets-graphics-optimization)
* [Game Performance Optimization - A Practical Example From Industry Idle](https://ruoyusun.com/2022/01/28/game-pref.html)
* [《Unity性能优化》系列课程——渲染性能优化篇（上）](https://zhuanlan.zhihu.com/p/589925491)