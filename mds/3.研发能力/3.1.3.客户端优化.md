<h2 align="center">客户端优化</h2>
<p>
现在的游戏都在追求极致表现和体验，这就需要做一系列的工作去"压榨"各种资源。客户端优化涉及性能、内存、包体、耗电、网络、加载等多个方面，每个方面都需要系统性的优化策略。
</p>

**关键词:** <br/> 
*客户端优化,优化,FPS,帧率,Profiler,性能优化,包体优化,耗电优化,网络优化,内存优化,加载优化,CPU优化,GPU优化,Graphics优化,Draw Call,Draw Primitive,线程优化,指令集优化,数学优化,sqrt,三角面优化,贴图优化,材质优化,视距,特效优化,渲染管线,Shader优化,Sampler,IO优化,Unity Profiler,UWA,GOT,性能保障,性能监控,数据序列化,延迟后台加载,aab包,延迟更新,资源压缩,贴图压缩,声音压缩,模型压缩,内存预算,系统内存预算,内存监控*

**标签:**<br/>
*等级: 中级|高级, 阶段: 优化, 分类: 研发能力, 角色: 客户端开发*

## 图谱

## 优化概览

## 性能优化

**是什么？在哪用？**

- **作用**：提升游戏运行性能，确保流畅的游戏体验
- **应用场景**：
  - 所有游戏项目
  - 对性能要求高的游戏
  - 移动设备游戏
  - 开放世界游戏
- **做什么的？** 提升游戏运行性能，确保流畅的游戏体验。
- **在哪用？** 所有游戏项目，特别是对性能要求高的游戏。

**会遇到哪些问题？用什么解决？**

- **如何确保游戏帧率稳定？**
  - **问题**：游戏帧率不稳定会影响游戏体验
  - **解决方向**：
    - 设定合理的帧率目标（至少20多FPS）
    - 使用Profiler工具分析性能瓶颈
    - 优化CPU和GPU负载
    - 实现帧率监控和报警
    - 优化渲染管线

- **如何优化 CPU 和 GPU 性能？**
  - **问题**：CPU和GPU是性能瓶颈的主要来源
  - **解决方向**：
    - **CPU优化：**
      - 减少Draw Call数量
      - 优化线程使用
      - 使用合适的指令集
      - 优化数学计算
      - 优化程序代码
    - **GPU优化：**
      - 减少三角面数量
      - 优化贴图和材质
      - 优化Shader
      - 控制视距和特效
      - 优化渲染管线

- **如何做好性能保障和监控？**
  - **问题**：需要持续监控性能，及时发现问题
  - **解决方向**：
    - 在程序设计和实现时考虑性能优化
    - 在数字内容制作前约定好规格
    - 每日构建和测试版本，记录性能指标
    - 使用Profiler工具持续监控
    - 建立性能预算和检查清单

**要点和思考方向：**

**优化目标：**
- 至少 20 多 FPS 才能让画面看上去不难受
- 不同游戏类型对帧率要求不同，需要根据实际情况设定目标

**性能保障方案：**
- **概述：** 事后发现问题、解决问题，代价总是很高的。尽量做好日常保障，并且能第一时间发现问题。
- **方法：**
  - 在程序设计和实现的时候，就考虑到性能优化
  - 在数字内容制作之前，尽量约定好规格
  - 每日构建和测试版本，记录性能指标。发现问题第一时间去找到和处理

**CPU 优化：**
- **Draw Primitive/Draw Call：** 数量决定 CPU 的负担
  - 尽可能的去合并可合并的模型
  - 注意：平衡好模型合并和可见性裁剪的关系
- **线程：** 检查是否有线程之间的等待，检查网络是否在独立的线程中操作
- **指令集：** 使用合适的指令集优化
- **数学优化：**
  - **sqrt：** 网络上可以搜到快速 Sqrt 的算法，如果精度能满足，就用那个
  - **化简或者预计算：** 有些高消耗的计算，如果可以预先把计算方法化简，或者预先可以知道结果，就预先做好公式简化或者替 CPU 算好
- **程序代码优化：**
  - **空间换时间：** 有些数据如果可以预先存在内存的，就不要在运行时算出来
  - **预先算出结果：** 有些公式如果预先可以算出结果的，就不要在运行时去运算

**Graphics 优化：**
- **三角面：**
  - 在保证效果的情况下，尽量减少模型面数
  - 通过可见性控制，降低同屏三角面数量
  - LOD（细节层次）优化
- **贴图：**
  - 平衡好贴图尺寸和清晰度
  - 生成 mipmap
  - 组织分配好图片元素的图集
  - 让贴图尺寸是 2 的幂
  - 压缩贴图
- **材质：**
  - 考虑 shader 的复杂度对性能的影响
  - 控制好半透明物体数量
- **视距：** 调整好摄像机远截面的距离
- **特效：** 控制好粒子数量
- **渲染管线/Shader：**
  - 减少 Sampler 函数
  - 如果能预先算好，就尽量减少一些数学函数的调用（如 sqrt、三角函数等）
  - 控制好数据运算精度
  - 能在 vs 中处理的，尽量不在 ps 中处理

**IO 优化：**
- IO 操作是性能较低的操作，尽量不要在 Update 中频繁的操作 IO
- **检查：**
  - 是否有频繁的读写文件 IO
  - 是否有频繁的内存分配和释放

## 优化工具

**是什么？在哪用？**

- **作用**：用于分析和定位性能问题的工具
- **应用场景**：
  - 性能优化阶段
  - 问题排查阶段
  - 性能测试阶段
- **做什么的？** 用于分析和定位性能问题的工具。
- **在哪用？** 性能优化和问题排查阶段。

**会遇到哪些问题？用什么解决？**

- **如何选择合适的性能分析工具？**
  - **问题**：不同工具适用于不同场景
  - **解决方向**：
    - 根据引擎选择工具（Unity、Unreal等）
    - 使用引擎自带的Profiler
    - 使用第三方专业工具（如UWA）
    - 结合多种工具综合分析
    - 建立工具使用规范

- **如何有效使用性能分析工具？**
  - **问题**：需要正确使用工具才能找到问题
  - **解决方向**：
    - 学习工具的使用方法
    - 建立性能分析流程
    - 定期进行性能分析
    - 记录和分析性能数据
    - 建立性能基准

**要点和思考方向：**

**Unity 引擎：**
- **自带的 Profiler：**
  - Code Profiler（代码性能分析）
  - Render Profiler（渲染性能分析）
  - Network Profiler（网络性能分析）
  - Memory Profiler（内存分析）
  - Physics Profiler（物理性能分析）
- **第三方：**
  - **UWA：**
    - GOT Local（本地性能分析）
    - GOT Online（在线性能分析）
    - 线上测评
    - 线下深度优化

**Unreal 引擎：**
- 自带的 Profiler

**程序代码：**
- **Profiler 工具举例：**
  - C++ Profiler
  - gprof

## 网络优化

**是什么？在哪用？**

- **作用**：优化网络通信性能，减少延迟和流量消耗
- **应用场景**：
  - 所有需要网络通信的游戏
  - 在线游戏
  - 多人游戏
- **做什么的？** 优化网络通信性能，减少延迟和流量消耗。
- **在哪用？** 所有需要网络通信的游戏。

**会遇到哪些问题？用什么解决？**

- **如何减少网络延迟？**
  - **问题**：网络延迟影响游戏体验
  - **解决方向**：
    - 使用多线程处理网络，避免让UI卡顿
    - 优化网络消息大小
    - 使用消息压缩
    - 优化网络协议
    - 使用CDN加速

- **如何减少网络流量消耗？**
  - **问题**：网络流量消耗影响用户体验和运营成本
  - **解决方向**：
    - 使用消息压缩
    - 减少不必要的网络请求
    - 使用增量更新
    - 优化消息格式
    - 实现消息缓存

- **如何选择消息压缩方案？**
  - **问题**：不同压缩方案有不同优缺点
  - **解决方向**：
    - **Protobuf：**
      - 利：压缩更高效
      - 弊：开发效率稍低
    - **JSON+gzip：**
      - 利：开发很便利
      - 弊：压缩效率和执行效率相对较低
    - 根据项目需求选择合适的方案

- **网络异常处理**
  - **问题**：网络异常需要妥善处理
  - **解决方向**：
    - 实现网络重连机制
    - 处理网络超时
    - 实现消息队列
    - 优化网络错误提示

**要点和思考方向：**
- **多线程：** 在独立线程中工作，避免让 UI 卡顿
- **消息压缩：**
  - **Protobuf：**
    - 利：压缩更高效
    - 弊：开发效率稍低
  - **JSON+gzip：**
    - 利：开发很便利
    - 弊：压缩效率和执行效率相对较低
- 考虑网络异常处理
- 优化网络协议和消息格式

## 加载优化

**是什么？在哪用？**

- **作用**：提高数据加载速度，让玩家尽快开始体验游戏
- **应用场景**：
  - 游戏启动
  - 场景切换
  - 资源加载
  - 关卡加载
- **做什么的？** 提高数据加载速度，让玩家尽快开始体验游戏。
- **在哪用？** 游戏启动、场景切换、资源加载等场景。

**会遇到哪些问题？用什么解决？**

- **如何提高加载速度？**
  - **问题**：加载速度慢影响游戏体验
  - **解决方向**：
    - 使用数据序列化，加载到内存直接使用数据
    - 实现异步加载
    - 优化资源格式
    - 使用资源压缩
    - 实现资源预加载

- **如何优化加载体验？**
  - **问题**：加载过程需要给用户良好体验
  - **解决方向**：
    - 实现加载进度显示
    - 使用延迟后台加载，非关键资源在后台异步加载
    - 实现加载动画
    - 优化加载界面
    - 实现加载提示

- **如何管理加载资源？**
  - **问题**：大量资源需要管理
  - **解决方向**：
    - 实现资源加载优先级
    - 实现资源依赖管理
    - 实现资源缓存机制
    - 优化资源加载流程
    - 实现资源预加载策略

- **加载性能优化**
  - **问题**：加载可能影响游戏性能
  - **解决方向**：
    - 使用多线程加载
    - 优化IO操作
    - 实现加载限流
    - 优化资源解压
    - 使用流式加载

**要点和思考方向：**
- **数据序列化：** 加载到内存直接使用数据，不需要再对数据进行解析、组织等操作
- **延迟后台加载：** 非关键资源可以在后台异步加载
- 考虑加载体验优化
- 实现资源加载管理
- 优化加载性能

## 包体优化

**是什么？在哪用？**

- **作用**：减小游戏安装包大小，提高下载转化率
- **应用场景**：
  - 游戏发布阶段
  - 游戏分发阶段
  - 应用商店上架
- **做什么的？** 减小游戏安装包大小，提高下载转化率。
- **在哪用？** 游戏发布和分发阶段。

**会遇到哪些问题？用什么解决？**

- **如何减小安装包大小？**
  - **问题**：安装包太大影响下载转化率
  - **解决方向**：
    - 使用aab包（上架Google Play的优化方案）
    - 实现延迟更新/下载，后期内容在游戏玩到一定阶段触发后台下载
    - 压缩资源
    - 移除不必要的资源
    - 使用资源分包

- **如何压缩资源？**
  - **问题**：资源占用大量空间
  - **解决方向**：
    - **贴图压缩：** 使用压缩格式
    - **声音压缩：**
      - 降低码率
      - 降低采样率
      - 使用压缩格式
    - **模型压缩：**
      - 优化面数
      - 优化顶点数据的位数
    - 使用通用压缩算法

- **包体分析和管理**
  - **问题**：需要分析包体组成，找出优化点
  - **解决方向**：
    - 使用包体分析工具
    - 分析资源占用情况
    - 建立资源使用规范
    - 实现资源审核流程
    - 定期进行包体优化

- **平台特定优化**
  - **问题**：不同平台有不同要求
  - **解决方向**：
    - iOS使用App Thinning
    - Android使用aab包
    - 实现平台特定资源
    - 优化平台特定配置

**要点和思考方向：**
- **aab 包：** 上架 Google Play 的包的一种优化方案
- **延迟更新/下载：** 有些后期会用到的游戏内容，在游戏玩到一定阶段，触发后台下载
- **资源压缩：**
  - **贴图压缩：** 使用压缩格式
  - **声音压缩：**
    - 降低码率
    - 降低采样率
    - 使用压缩格式
  - **模型压缩：**
    - 优化面数
    - 优化顶点数据的位数
- 考虑包体分析和管理
- 实现平台特定优化

## 耗电优化

**是什么？在哪用？**

- **作用**：降低游戏功耗，延长设备续航时间
- **应用场景**：
  - 移动设备游戏
  - 需要长时间运行的游戏
  - 电池续航敏感的游戏
- **做什么的？** 降低游戏功耗，延长设备续航时间。
- **在哪用？** 移动设备游戏，特别是需要长时间运行的游戏。

**会遇到哪些问题？用什么解决？**

- **如何降低游戏功耗？**
  - **问题**：游戏功耗高影响设备续航
  - **解决方向**：
    - **优化IO：** 内存、文件、网络
    - **优化CPU：** 减少不必要的计算
    - **优化渲染：** 降低渲染负载
    - 优化GPU使用
    - 实现动态性能调整

- **如何优化CPU功耗？**
  - **问题**：CPU是耗电的主要来源
  - **解决方向**：
    - 减少不必要的计算
    - 优化算法复杂度
    - 使用低功耗模式
    - 优化线程使用
    - 减少频繁的更新

- **如何优化GPU功耗？**
  - **问题**：GPU渲染耗电
  - **解决方向**：
    - 降低渲染负载
    - 优化渲染管线
    - 减少Draw Call
    - 优化Shader
    - 实现动态LOD

- **如何优化IO功耗？**
  - **问题**：IO操作耗电
  - **解决方向**：
    - 减少文件IO操作
    - 优化网络IO
    - 使用内存缓存
    - 批量处理IO操作
    - 优化数据读写

- **功耗监控**
  - **问题**：需要监控功耗变化
  - **解决方向**：
    - 使用功耗分析工具
    - 监控CPU和GPU使用率
    - 建立功耗基准
    - 定期进行功耗测试

**要点和思考方向：**
- **优化 IO：** 内存、文件、网络
- **优化 CPU：** 减少不必要的计算
- **优化渲染：** 降低渲染负载
- 考虑GPU功耗优化
- 实现功耗监控
- 建立功耗优化策略

## 内存优化

**是什么？在哪用？**

- **作用**：优化内存使用，提高设备适配性
- **应用场景**：
  - 所有游戏项目
  - 移动设备游戏
  - 内存受限的设备
- **做什么的？** 优化内存使用，提高设备适配性。
- **在哪用？** 所有游戏项目，特别是移动设备游戏。

**会遇到哪些问题？用什么解决？**

- **如何做好资源内存预算？**
  - **问题**：资源占用大量内存，需要合理规划
  - **解决方向**：
    - **举例：** 贴图、模型、音效、游戏对象
    - **方法：** 在游戏或系统设计的前期，程序、美术共同对各种资源的使用量做个初步规划
    - 建立资源内存预算表
    - 定期检查资源使用情况
    - 优化资源内存占用

- **如何做好系统内存预算？**
  - **问题**：系统内存需要合理分配
  - **解决方向**：
    - 做好系统内存预算，尽量为各个系统预先分配好内存
    - 建立系统内存预算表
    - 优化系统内存使用
    - 实现内存池管理
    - 定期检查系统内存使用

- **如何做好内存监控？**
  - **问题**：需要持续监控内存使用情况
  - **解决方向**：
    - 在开发过程中，监控好内存的变化
    - 在开发前期可能会超预算使用，后期要寻找可优化的内容
    - 使用Profiler工具进行持续记录
    - 实现内存监控系统
    - 建立内存报警机制

- **内存泄漏检测**
  - **问题**：内存泄漏会导致内存持续增长
  - **解决方向**：
    - 使用内存分析工具检测泄漏
    - 实现对象引用计数
    - 检查资源释放
    - 定期进行内存泄漏测试
    - 建立内存泄漏检查流程

- **内存碎片优化**
  - **问题**：内存碎片影响内存使用效率
  - **解决方向**：
    - 使用内存池减少碎片
    - 优化内存分配策略
    - 实现内存整理
    - 使用对象池管理
    - 优化资源加载和释放

**要点和思考方向：**
- **作用：** 更少的内存使用将获得更大的设备适配性
- **做好资源内存预算：**
  - **举例：** 贴图、模型、音效、游戏对象
  - **方法：** 在游戏或系统设计的前期，程序、美术共同对各种资源的使用量做个初步规划
- **做好系统内存预算：** 尽量为各个系统预先分配好内存
- **做好内存监控：**
  - 在开发的过程中，监控好内存的变化。在开发的前期，可能会超预算的使用，不过在后期就要开始寻找可优化的内容
  - 使用 Profiler 工具进行持续的记录
- 考虑内存泄漏检测
- 优化内存碎片
- 建立内存优化策略

## 更多资料
* [Code Optimizations for Game Development: Basic Structures and Mindsets](https://gamedevelopment.tutsplus.com/tutorials/code-optimizations-for-game-development-basic-structures-and-mindsets--cms-30760)
* [Research on the 3D Game Scene Optimization of Mobile Phone Based on the Unity 3D Engine](https://ieeexplore.ieee.org/abstract/document/6086340)
* [Game Assets (Graphics) Optimization](https://www.theappguruz.com/blog/game-assets-graphics-optimization)
* [Game Performance Optimization - A Practical Example From Industry Idle](https://ruoyusun.com/2022/01/28/game-pref.html)
* [《Unity性能优化》系列课程——渲染性能优化篇（上）](https://zhuanlan.zhihu.com/p/589925491)