<h2 align="center">网游网络同步</h2>
<p>
网络游戏中，玩家之间需要同步信息（数据/状态），不同的游戏类型对信息同步的要求也不相同。你的产品需要哪些同步上的考量？在多人游戏中，每个玩家都会看到自己的游戏画面，但其他玩家的游戏画面可能会与自己的有所不同，这是因为网络延迟和带宽限制等因素的影响。为了保持游戏的一致性，需要进行同步，使每个玩家都看到相同的游戏状态和行为。
</p>

**关键词:**<br/>
*AOI,状态同步,帧同步，混合同步,插值,预测,校正*

**标签:**<br/>
*等级: 高级, 阶段: 开发, 分类: 研发能力, 角色: 服务端开发|客户端开发*

## 图谱

## 目录

- [同步概览](#同步概览)
- [说明](#说明)
- [同步方式](#同步方式)
- [同步技术](#同步技术)
- [同步内容](#同步内容)
- [AOI（Area of Interest，兴趣区域）](#aoiarea-of-interest兴趣区域)
- [更多资料](#更多资料)

----

## 同步概览

## 说明

**是什么？在哪用？**

- **作用**：在多人游戏中保持游戏状态的一致性
- **应用场景**：
  - 所有多人网络游戏
  - 实时对战游戏
  - 多人在线游戏
- **做什么的？** 在多人游戏中保持游戏状态的一致性。
- **在哪用？** 所有多人网络游戏。

**会遇到哪些问题？用什么解决？**

- **如何保持多个玩家看到的游戏状态一致？**
  - **问题**：不同玩家看到的游戏状态可能不一致
  - **解决方向**：
    - 使用服务器作为权威状态源
    - 实现状态同步机制
    - 使用帧同步保证一致性
    - 实现状态校验和修正
    - 处理状态冲突

- **如何处理网络延迟和带宽限制？**
  - **问题**：网络延迟和带宽限制影响同步效果
  - **解决方向**：
    - 使用客户端预测减少延迟感
    - 使用插值平滑状态变化
    - 实现延迟补偿
    - 优化同步数据量
    - 使用AOI减少同步范围
    - 实现数据压缩

**要点和思考方向：**
- 在多人游戏中，每个玩家都会看到自己的游戏画面，但其他玩家的游戏画面可能会与自己的有所不同，这是因为网络延迟和带宽限制等因素的影响
- 为了保持游戏的一致性，需要进行同步，使每个玩家都看到相同的游戏状态和行为
- 使用服务器作为权威状态源
- 实现客户端预测和插值优化体验

## 同步方式

**是什么？在哪用？**

- **作用**：选择适合游戏类型的同步方式
- **应用场景**：
  - 根据游戏类型选择合适的同步方案
  - 实时对战游戏
  - 多人在线游戏
- **做什么的？** 选择适合游戏类型的同步方式。
- **在哪用？** 根据游戏类型选择合适的同步方案。

**会遇到哪些问题？用什么解决？**

- **什么时候用状态同步，什么时候用帧同步？**
  - **问题**：需要根据游戏类型选择合适的同步方式
  - **解决方向**：
    - **状态同步：**
      - **应用场景：** 实时性不高的游戏，比如SLG
      - **特点：** 发指令，收状态。客户端发送指令给服务器，服务器处理后返回结果（状态）
      - **优势：** 实现简单、服务器负担小
      - **劣势：** 实时性较差、需要处理冲突
    - **帧同步：**
      - **应用场景：** 实时性较高的游戏，比如RTS、FPS
      - **特点：** 发操作，收操作
      - **优势：** 传输数据少、操作响应快、状态一致性好
      - **劣势：** 实现复杂、需要处理网络稳定性、需要防止作弊

- **两种同步方式有什么区别？**
  - **问题**：需要理解两种同步方式的区别
  - **解决方向**：
    - **状态同步：**
      - **基于对等网络：** 每个客户端都保存着完整的游戏状态，并通过网络将状态同步到其他客户端。这种同步方式可以减少服务器负担，但需要处理玩家之间的冲突和延迟问题
      - **数据量：** 较大，需要传输完整状态
      - **实时性：** 较低，适合回合制或低实时游戏
    - **帧同步：**
      - **基于服务器：** 将游戏状态保存在游戏服务器上，并在每个客户端之间进行通信以更新状态。客户端会将自己的行为发送到服务器，服务器会验证并更新游戏状态，然后将新状态发送回每个客户端。这种同步方式可以保证游戏状态的一致性，但也会增加网络延迟和服务器负担
      - **数据量：** 较小，只传输操作指令
      - **实时性：** 较高，适合实时对战游戏
      - **保障：**
        - **网络稳定性：** UDP、断线重连
        - **作弊问题：** 需要防止客户端作弊

- **混合同步**
  - **问题**：某些游戏可能需要混合使用两种同步方式
  - **解决方向**：
    - 不同系统使用不同的同步方式
    - 关键系统使用帧同步
    - 非关键系统使用状态同步
    - 实现同步方式切换机制

**要点和思考方向：**

**状态同步：**
- **说明：** 发指令，收状态。客户端发送指令给服务器，服务器处理后返回结果（状态）
- **基于对等网络：** 每个客户端都保存着完整的游戏状态，并通过网络将状态同步到其他客户端。这种同步方式可以减少服务器负担，但需要处理玩家之间的冲突和延迟问题
- **应用场景：** 实时性不高的游戏，比如SLG

**帧同步：**
- **说明：** 发操作，收操作
- **基于服务器：** 将游戏状态保存在游戏服务器上，并在每个客户端之间进行通信以更新状态。客户端会将自己的行为发送到服务器，服务器会验证并更新游戏状态，然后将新状态发送回每个客户端。这种同步方式可以保证游戏状态的一致性，但也会增加网络延迟和服务器负担
- **特点：**
  - 传输数据少
  - 操作响应快
- **保障：**
  - **网络稳定性：** UDP、断线重连
  - **作弊问题：** 需要防止客户端作弊
- **应用场景：** 实时性较高的游戏，比如RTS、FPS

## 同步技术

**是什么？在哪用？**

- **作用**：优化同步效果的技术手段
- **应用场景**：
  - 所有网络同步系统
  - 实时游戏同步
  - 减少延迟感
- **做什么的？** 优化同步效果的技术手段。
- **在哪用？** 所有网络同步系统。

**会遇到哪些问题？用什么解决？**

- **如何减少延迟感？**
  - **问题**：网络延迟导致操作响应慢
  - **解决方向**：
    - **预测：** 减少延迟，客户端预测服务器状态
      - 客户端立即响应操作
      - 服务器验证后校正
      - 处理预测错误
    - 使用客户端预测
    - 优化网络路径
    - 使用就近服务器

- **如何平滑状态变化？**
  - **问题**：状态突然变化导致画面不流畅
  - **解决方向**：
    - **插值：** 平滑游戏状态的变化
      - 使用线性插值
      - 使用样条插值
      - 优化插值算法
    - 实现状态平滑过渡
    - 优化插值性能

- **如何修正状态偏差？**
  - **问题**：网络延迟导致状态偏差
  - **解决方向**：
    - **校正：** 修正由于网络延迟引起的游戏状态偏差
      - 检测状态偏差
      - 平滑校正状态
      - 处理校正冲突
    - 实现延迟补偿
    - 使用回滚和重放
    - 优化校正算法

- **同步技术性能优化**
  - **问题**：同步技术可能影响性能
  - **解决方向**：
    - 优化预测算法
    - 优化插值计算
    - 限制校正频率
    - 使用GPU加速
    - 实现同步技术开关

**要点和思考方向：**
- **插值：** 平滑游戏状态的变化
- **预测：** 减少延迟，客户端预测服务器状态
- **校正：** 修正由于网络延迟引起的游戏状态偏差
- 合理使用同步技术优化体验
- 注意同步技术的性能开销

## 同步内容

**是什么？在哪用？**

- **作用**：确定需要同步的游戏内容
- **应用场景**：
  - 设计同步系统时
  - 确定同步数据
  - 优化同步性能
- **做什么的？** 确定需要同步的游戏内容。
- **在哪用？** 设计同步系统时。

**会遇到哪些问题？用什么解决？**

- **如何确定需要同步的内容？**
  - **问题**：需要确定哪些内容需要同步
  - **解决方向**：
    - **物理：** 位置、旋转、速度
      - 同步角色位置和移动
      - 同步物体状态
      - 优化物理同步精度
    - **动画：** 角色动画状态
      - 同步动画播放状态
      - 同步动画参数
      - 优化动画同步频率
    - **特效：** 技能特效、粒子效果
      - 同步特效触发
      - 同步特效参数
      - 优化特效同步
    - **碰撞：** 碰撞检测结果
      - 同步碰撞事件
      - 同步碰撞结果
      - 处理碰撞冲突

- **如何优化同步数据量？**
  - **问题**：同步数据量大影响性能
  - **解决方向**：
    - 只同步必要的数据
    - 使用增量同步
    - 实现数据压缩
    - 使用AOI减少同步范围
    - 优化数据格式

- **同步优先级管理**
  - **问题**：不同内容有不同的同步优先级
  - **解决方向**：
    - 定义同步优先级
    - 高优先级内容优先同步
    - 低优先级内容可以延迟同步
    - 实现同步频率控制

**要点和思考方向：**
- **物理：** 位置、旋转、速度
- **动画：** 角色动画状态
- **特效：** 技能特效、粒子效果
- **碰撞：** 碰撞检测结果
- 只同步必要的数据
- 实现同步优先级管理
- 优化同步数据量

## AOI（Area of Interest，兴趣区域）

**是什么？在哪用？**

- **作用**：管理玩家之间的可见性和交互性的空间管理算法
- **应用场景**：
  - 大型多人在线游戏
  - 需要控制同步范围的游戏
  - 大量玩家同时在线的场景
- **做什么的？** 管理玩家之间的可见性和交互性的空间管理算法。
- **在哪用？** 大型多人在线游戏。

**会遇到哪些问题？用什么解决？**

- **当大量用户同时在线，如何避免信息量"大爆炸"？**
  - **问题**：大量玩家同时在线导致同步数据量爆炸
  - **解决方向**：
    - **说明：** Area of Interest，兴趣区域。是一种用于多人在线游戏开发的空间管理算法，用于管理玩家之间的可见性和交互性
    - **方法：** 将游戏世界划分为若干个空间区域，每个区域称为一个兴趣区域（Interest Area），每个玩家位于一个或多个兴趣区域中。当玩家进入或离开一个兴趣区域时，系统会触发事件通知其他与该区域相交的玩家，从而保证玩家之间的可见性和交互性
    - **解决问题：** 当大量用户同时在线，并且可以互相看到和互动。就需要有一个方案，在避免传递信息量"大爆炸"的前提下，来控制信息的同步
    - 使用AOI算法限制同步范围
    - 只同步可见区域内的玩家
    - 实现动态AOI更新

- **如何控制信息的同步范围？**
  - **问题**：需要控制同步信息的范围
  - **解决方向**：
    - **算法：**
      - **灯塔法：** 使用灯塔标记兴趣区域
      - **九宫格：** 将世界划分为九宫格，管理相邻区域
      - **十字链表法：** 使用十字链表管理空间关系
    - 根据玩家位置动态更新AOI
    - 实现AOI进入和离开事件
    - 优化AOI计算性能

- **AOI性能优化**
  - **问题**：AOI计算可能影响性能
  - **解决方向**：
    - 优化AOI算法
    - 使用空间索引加速查询
    - 限制AOI更新频率
    - 使用多线程处理AOI
    - 实现AOI缓存

**要点和思考方向：**
- **说明：** Area of Interest，兴趣区域。是一种用于多人在线游戏开发的空间管理算法，用于管理玩家之间的可见性和交互性
- **方法：** 将游戏世界划分为若干个空间区域，每个区域称为一个兴趣区域（Interest Area），每个玩家位于一个或多个兴趣区域中。当玩家进入或离开一个兴趣区域时，系统会触发事件通知其他与该区域相交的玩家，从而保证玩家之间的可见性和交互性
- **解决问题：** 当大量用户同时在线，并且可以互相看到和互动。就需要有一个方案，在避免传递信息量"大爆炸"的前提下，来控制信息的同步
- **算法：**
  - 灯塔法
  - 九宫格
  - 十字链表法
- **应用举例：**
  - 玩家交互
  - 动态对象的移动
  - NPC的行为

## 更多资料
* [Game server AOI implementation](https://programmerall.com/article/24132060302/)
* [帧同步：原理与实现](https://zhuanlan.zhihu.com/p/556920018?utm_campaign=&utm_medium=social&utm_oi=27483965489152&utm_psn=1545491230850514944&utm_source=qq) - 本文的主题是网络游戏帧同步技术详解，会用深入浅出的方式来为大家介绍帧同步的原理，以及如何实现