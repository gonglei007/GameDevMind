<h2 align="center">服务端优化</h2>
<p>
服务器是资源和资产使用的大头，一方面为了产品的稳定性，另一方面为了运营成本，服务端的优化也是一项重要的工作。服务端优化涉及网络、负载、并发、数据库等多个方面。
</p>

**关键词:**<br/> 
*负载,压力测试,并发,RT,TPS,ProtoBuf,连接池*

**标签:**<br/>
*等级: 中级|高级, 阶段: 优化, 分类: 研发能力, 角色: 服务端开发*

## 图谱

## 优化概览

## 术语

**是什么？在哪用？**

- **作用**：性能优化的关键指标
- **应用场景**：
  - 性能评估
  - 性能监控
  - 性能优化
- **做什么的？** 性能优化的关键指标。

**会遇到哪些问题？用什么解决？**

- **如何评估服务器性能？**
  - **问题**：需要量化指标评估服务器性能
  - **解决方向**：
    - **RT（Response Time）：** 从发送请求到获得结果的响应时间，包括请求时间和回应时间
      - 评估响应速度
      - 监控响应时间分布
      - 设置响应时间阈值
    - **TPS（Transactions Per Second）：** 每秒处理的事务数
      - 评估处理能力
      - 监控TPS变化
      - 设置TPS目标值
    - 使用性能监控工具
    - 建立性能基线
    - 设置性能告警

**要点和思考方向：**
- **RT（Response Time）：** 从发送请求到获得结果的响应时间，包括请求时间和回应时间
- **TPS（Transactions Per Second）：** 每秒处理的事务数
- 建立性能监控体系
- 设置合理的性能目标
- 定期评估和优化性能指标

## 网络

**是什么？在哪用？**

- **作用**：优化网络消息传输，减少流量和延迟
- **应用场景**：
  - 所有网络通信
  - 客户端-服务端通信
  - 服务端间通信
- **做什么的？** 优化网络消息传输，减少流量和延迟。
- **在哪用？** 所有网络通信。

**会遇到哪些问题？用什么解决？**

- **如何减少网络消息的数据量？**
  - **问题**：网络消息数据量大，影响性能和成本
  - **解决方向**：
    - **消息压缩：**
      - **ProtoBuf：** 一种轻便高效的结构化数据存储格式，可以用于结构化数据串行化，或者说序列化。需要对每个消息进行定义。如果之前没有使用，需要有一定的转化工作
        - 优点：体积小、序列化快、跨语言
        - 缺点：需要定义消息结构、需要转换工作
      - **gzip：** 可以对现有的消息数据（比如json、xml）进行压缩。http还直接支持gzip压缩的设置
        - 优点：实现简单、兼容性好
        - 缺点：压缩率相对较低
    - 优化消息结构
    - 使用二进制协议
    - 实现消息合并
    - 减少冗余数据

- **如何优化网络性能？**
  - **问题**：网络延迟和带宽影响性能
  - **解决方向**：
    - **意义：**
      - **运营更省钱：** 更省流量（特别是如果做了全球加速）
      - **玩家体验更好：** 让玩家更省流量、让游戏前后端交互更流畅、让手机耗电更慢
    - 使用内网通信
    - 优化网络路径
    - 使用CDN加速
    - 实现消息批处理
    - 优化网络协议

- **网络架构优化**
  - **问题**：网络架构可能影响性能
  - **解决方向**：
    - **检查清单：**
      - 服务之间的访问走的是外网还是内网？比如服务器之间访问、服务器访问数据库等
      - 使用内网通信减少延迟
      - 优化网络拓扑
      - 使用负载均衡
      - 实现网络监控

**要点和思考方向：**
- 消息压缩可以显著减少流量和成本
- 使用内网通信提高性能
- 优化消息结构减少数据量
- 监控网络性能指标

## 负载

**是什么？在哪用？**

- **作用**：优化服务器负载，提高处理能力
- **应用场景**：
  - 所有服务端系统
  - 高并发场景
  - 性能优化
- **做什么的？** 优化服务器负载，提高处理能力。
- **在哪用？** 所有服务端系统。

**会遇到哪些问题？用什么解决？**

- **如何提高服务器的处理能力？**
  - **问题**：服务器处理能力不足
  - **解决方向**：
    - **性能记录：** 对各个请求的响应时间进行统计记录（最大时长、最小时长、平均时长）
      - 建立性能监控
      - 记录性能指标
      - 分析性能趋势
    - **性能分析：** 分析性能瓶颈
      - 识别性能瓶颈
      - 分析瓶颈原因
      - 制定优化方案
    - **性能优化：**
      - **分布式：** 将服务分布到多台服务器
        - 提高处理能力
        - 提高可用性
        - 实现负载均衡
      - **多进程：** 使用多进程处理请求
        - 充分利用多核CPU
        - 提高并发处理能力
        - 隔离进程故障
      - **分离模块：** 将不同功能分离到不同模块
        - 提高模块独立性
        - 优化模块性能
        - 便于扩展和维护

- **如何充分利用CPU多核？**
  - **问题**：CPU多核未充分利用
  - **解决方向**：
    - 使用多进程/多线程
    - 实现负载均衡
    - 优化任务分配
    - 使用异步处理
    - 避免锁竞争

- **负载监控和优化**
  - **问题**：需要监控和优化负载
  - **解决方向**：
    - **检查清单：**
      - CPU的多核是否充分使用了？
      - CPU的使用率是否太高了？
    - 监控CPU使用率
    - 监控内存使用率
    - 监控网络IO
    - 监控磁盘IO
    - 设置负载告警

**要点和思考方向：**
- 性能记录和分析是优化的基础
- 分布式、多进程、分离模块是提高处理能力的有效方法
- 充分利用CPU多核提高性能
- 建立完善的监控体系

## 并发

**是什么？在哪用？**

- **作用**：处理并发操作，避免数据竞争
- **应用场景**：
  - 需要处理并发请求的系统
  - 高并发场景
  - 多线程/多进程系统
- **做什么的？** 处理并发操作，避免数据竞争。
- **在哪用？** 需要处理并发请求的系统。

**会遇到哪些问题？用什么解决？**

- **如何处理并发异步操作？**
  - **问题**：并发异步操作可能导致数据竞争和时序问题
  - **解决方向**：
    - **解决问题：** 并发异步操作，比如访问数据库，会有读写数据时序的问题。一次执行一个事务/任务，来避免IO读写的交叉使用
    - 使用锁机制
    - 使用消息队列
    - 使用Actor模型
    - 实现事务管理
    - 使用无锁数据结构

- **如何避免IO读写的交叉使用？**
  - **问题**：IO读写交叉使用可能导致数据不一致
  - **解决方向**：
    - 使用队列串行化IO操作
    - 使用事务保证原子性
    - 实现读写分离
    - 使用连接池管理
    - 避免并发IO冲突

- **并发性能优化**
  - **问题**：并发处理可能影响性能
  - **解决方向**：
    - 减少锁竞争
    - 使用无锁编程
    - 优化锁粒度
    - 使用读写锁
    - 实现并发控制策略

**要点和思考方向：**
- 并发异步操作需要避免数据竞争
- 使用队列串行化IO操作避免交叉使用
- 合理使用锁机制
- 优化并发性能

## 压力测试

**是什么？在哪用？**

- **作用**：测试服务器在高负载下的表现
- **应用场景**：
  - 服务器上线前
  - 性能优化阶段
  - 容量规划
  - 性能评估
- **做什么的？** 测试服务器在高负载下的表现。
- **在哪用？** 服务器上线前和性能优化阶段。

**会遇到哪些问题？用什么解决？**

- **如何模拟真实玩家的访问？**
  - **问题**：需要模拟真实玩家行为进行压力测试
  - **解决方向**：
    - **模拟机器人：**
      - **作用：** 模拟真人玩家访问服务器
      - **实现方式：**
        - **录制重放：** 录制玩家消息，然后重放
          - 优点：真实反映玩家行为
          - 缺点：需要大量录制数据
        - **机器学习：** 使用机器学习技术来模拟玩家的行为
          - 优点：可以生成大量测试数据
          - 缺点：需要训练模型
    - 使用压力测试工具
    - 实现自定义测试脚本
    - 模拟不同场景的玩家行为

- **如何评估服务器的性能？**
  - **问题**：需要量化评估服务器性能
  - **解决方向**：
    - 监控RT（响应时间）
    - 监控TPS（每秒事务数）
    - 监控资源使用率（CPU、内存、网络、磁盘）
    - 监控错误率
    - 分析性能瓶颈
    - 建立性能基线

- **压力测试工具和方法**
  - **问题**：需要选择合适的压力测试工具和方法
  - **解决方向**：
    - **第三方测试服务：** 使用专业的压力测试服务
      - 优点：专业、全面
      - 缺点：成本较高
    - 使用开源压力测试工具（如JMeter、Locust）
    - 实现自定义压力测试框架
    - 建立压力测试流程

**要点和思考方向：**
- 压力测试是评估服务器性能的重要手段
- 模拟真实玩家行为很重要
- 建立完善的性能监控体系
- 定期进行压力测试

## 数据库优化

**是什么？在哪用？**

- **作用**：优化数据库访问性能
- **应用场景**：
  - 所有需要数据库的系统
  - 高并发数据库访问
  - 性能优化
- **做什么的？** 优化数据库访问性能。
- **在哪用？** 所有需要数据库的系统。

**会遇到哪些问题？用什么解决？**

- **如何优化数据库响应时间？**
  - **问题**：数据库响应时间过长
  - **解决方向**：
    - **优化响应时间和网络延迟：**
      - **使用缓存：** 减少数据库访问
        - 使用Redis等缓存数据库
        - 实现多级缓存
        - 设置合理的缓存策略
      - **批量读写：** 减少数据库访问次数
        - 批量插入数据
        - 批量查询数据
        - 减少网络往返
      - **异步IO：** 使用异步IO提高并发
        - 使用异步数据库驱动
        - 实现异步查询
        - 避免阻塞主线程
    - **MySQL优化：**
      - **索引：** 优化查询性能
        - 创建合适的索引
        - 避免索引过多
        - 定期分析索引使用情况
      - **数据结构：** 优化表结构
        - 规范化设计
        - 合理使用数据类型
        - 优化表分区
    - 优化SQL查询
    - 使用读写分离
    - 实现分库分表

- **如何优化网络延迟？**
  - **问题**：数据库网络延迟影响性能
  - **解决方向**：
    - 使用内网连接数据库
    - 使用数据库连接池
    - 优化网络路径
    - 使用就近数据库
    - 实现数据库代理

- **如何设计连接池？**
  - **问题**：连接池设计不合理影响性能
  - **解决方向**：
    - **连接池：**
      - **检查清单：** 检查连接池大小
        - **池子太大：** 会增加数据库压力
        - **池子太小：** 会让业务堆积，处理延时
      - 根据并发量设置连接数
      - 监控连接使用情况
      - 实现连接池动态调整
      - 处理连接泄漏
      - 设置连接超时

- **数据库集群和扩展**
  - **问题**：单数据库性能不足
  - **解决方向**：
    - **集群：** 使用数据库集群提高性能
      - 主从复制
      - 读写分离
      - 分片存储
    - 使用数据库代理
    - 实现数据库负载均衡
    - 监控集群状态

- **不同数据库的优化**
  - **问题**：不同数据库有不同的优化方法
  - **解决方向**：
    - **Mongodb：** NoSQL数据库优化
      - 优化索引
      - 优化查询
      - 使用分片
      - 优化文档结构
    - **Redis：** 缓存数据库优化
      - 优化数据结构
      - 使用管道
      - 实现集群
      - 优化内存使用

**要点和思考方向：**
- 使用缓存、批量读写、异步IO优化响应时间
- 合理设计连接池大小
- 使用集群提高性能
- 针对不同数据库采用不同的优化策略

## 更多资料
