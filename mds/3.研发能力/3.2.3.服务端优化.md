<h2 align="center">服务端优化</h2>
<p>
服务器是资源和资产使用的大头，一方面为了产品的稳定性，另一方面为了运营成本，服务端的优化也是一项重要的工作。服务端优化涉及网络、负载、并发、数据库等多个方面。
</p>

**关键词:**<br/> 
*负载,压力测试,并发,RT,TPS,ProtoBuf,连接池*

## 图谱
![图片加载中...](../../exports/3.2.3.服务端优化.png?raw=true)

## 优化概览

### 术语

**做什么的？** 性能优化的关键指标。

**要点和思考方向：**
- **RT（Response Time）：** 从发送请求到获得结果的响应时间，包括请求时间和回应时间
- **TPS（Transactions Per Second）：** 每秒处理的事务数

### 网络

**做什么的？** 优化网络消息传输，减少流量和延迟。

**在哪用？** 所有网络通信。

**会遇到哪些问题？**
- 如何减少网络消息的数据量？
- 如何优化网络性能？

**要点和思考方向：**

**消息优化：**
- **意义：**
  - **运营更省钱：** 更省流量（特别是如果做了全球加速）
  - **玩家体验更好：** 让玩家更省流量、让游戏前后端交互更流畅、让手机耗电更慢
- **消息压缩：**
  - **ProtoBuf：** 一种轻便高效的结构化数据存储格式，可以用于结构化数据串行化，或者说序列化。需要对每个消息进行定义。如果之前没有使用，需要有一定的转化工作
  - **gzip：** 可以对现有的消息数据（比如json、xml）进行压缩。http还直接支持gzip压缩的设置

**检查清单：**
- 服务之间的访问走的是外网还是内网？比如服务器之间访问、服务器访问数据库等

### 负载

**做什么的？** 优化服务器负载，提高处理能力。

**在哪用？** 所有服务端系统。

**会遇到哪些问题？**
- 如何提高服务器的处理能力？
- 如何充分利用CPU多核？

**要点和思考方向：**
- **性能记录：** 对各个请求的响应时间进行统计记录（最大时长、最小时长、平均时长）
- **性能分析：** 分析性能瓶颈
- **性能优化：**
  - 分布式
  - 多进程
  - 分离模块
- **检查清单：**
  - CPU的多核是否充分使用了？
  - CPU的使用率是否太高了？

### 并发

**做什么的？** 处理并发操作，避免数据竞争。

**在哪用？** 需要处理并发请求的系统。

**会遇到哪些问题？**
- 如何处理并发异步操作？
- 如何避免IO读写的交叉使用？

**要点和思考方向：**
- **解决问题：** 并发异步操作，比如访问数据库，会有读写数据时序的问题。一次执行一个事务/任务，来避免IO读写的交叉使用

### 压力测试

**做什么的？** 测试服务器在高负载下的表现。

**在哪用？** 服务器上线前和性能优化阶段。

**会遇到哪些问题？**
- 如何模拟真实玩家的访问？
- 如何评估服务器的性能？

**要点和思考方向：**
- **模拟机器人：**
  - **作用：** 模拟真人玩家访问服务器
  - **实现方式：**
    - 录制玩家消息，然后重放
    - 机器学习技术来模拟玩家的行为
- **第三方测试服务：** 使用专业的压力测试服务

### 数据库优化

**做什么的？** 优化数据库访问性能。

**在哪用？** 所有需要数据库的系统。

**会遇到哪些问题？**
- 如何优化数据库响应时间？
- 如何优化网络延迟？
- 如何设计连接池？

**要点和思考方向：**
- **优化响应时间和网络延迟：**
  - 使用缓存
  - 批量读写
  - 异步IO
- **集群：** 使用数据库集群提高性能
- **连接池：**
  - **检查清单：** 检查连接池大小
    - 池子太大，会增加数据库压力
    - 池子太小，会让业务堆积，处理延时
- **MySQL优化：**
  - 索引
  - 数据结构
- **Mongodb：** NoSQL数据库优化
- **Redis：** 缓存数据库优化

## 更多资料
