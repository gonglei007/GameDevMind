<h2 align="center">服务端基础功能</h2>
<p>
服务端环境的运转，除了业务功能以外，还需要一系列的基础功能来支撑其稳定、高效的开发和运转。这些基础功能包括数据库系统、日志系统、配置系统、Actor模型、测试、更新、服务器管理等。
</p>

**关键词:**<br/>
*Pool,ORM,ELK,Actor,蓝绿更新,灰度更新,滚动更新*

**标签:**<br/>
*等级: 中级|高级, 阶段: 开发, 分类: 研发能力, 角色: 服务端开发*

## 图谱
![图片加载中...](../../exports/3.2.4.服务端基础功能.png)

## 功能概览

### 功能系统

**是什么？在哪用？**

- **作用**：服务端的基础功能系统
- **应用场景**：
  - 所有服务端系统
  - 数据库访问
  - 日志记录
  - 配置管理
- **做什么的？** 服务端的基础功能系统。
- **在哪用？** 所有服务端系统。

**会遇到哪些问题？用什么解决？**

- **数据库系统：**
  - **问题**：数据库访问性能和管理问题
  - **解决方向**：
    - **连接池：**
      - **解决问题：** 平衡池子数量。池子太小，请求被阻塞；池子太大，数据库访问压力过大
      - 根据并发量设置连接数
      - 监控连接使用情况
      - 实现连接池动态调整
    - **异常处理：** 处理数据库访问异常
      - 实现重试机制
      - 处理连接超时
      - 记录异常日志
    - **考虑：** 延迟控制在100ms
      - 优化查询性能
      - 使用缓存
      - 实现异步IO
    - **ORM（Object-Relational Mapping）：**
      - 对象关系映射
      - 适用于关系型数据库
      - 可以通过对象的方式操作数据库，而不需要直接使用SQL语句
      - 简化数据库操作
      - 提高开发效率
    - **持久化：** 合并、延迟做持久化
      - 减少数据库访问次数
      - 提高性能
      - 实现批量写入
    - **调试：** 要方便查询、修改、调试、分析数据
      - 提供数据库管理工具
      - 实现数据查询接口
      - 支持数据导出

- **日志系统：**
  - **问题**：日志记录、查询和分析问题
  - **解决方向**：
    - **要考虑：**
      - 能支持海量数据IO，不对业务服务器造成压力
        - 使用异步日志
        - 实现日志缓冲
        - 使用日志收集服务
      - 要能快速查询所需信息
        - 使用索引
        - 实现日志搜索
        - 使用日志分析工具
      - 要能做统计分析
        - 实现日志聚合
        - 使用数据分析工具
        - 生成统计报告
    - **日志收集：** ELK
      - **Elasticsearch：** 日志存储和搜索
        - 分布式搜索
        - 实时查询
        - 数据聚合
      - **Logstash：** 日志收集
        - 日志收集
        - 数据转换
        - 数据过滤
      - **Kibana：** 查看日志
        - 可视化展示
        - 日志查询
        - 数据分析

- **配置系统：**
  - **问题**：配置管理和更新问题
  - **解决方向**：
    - **配表数据：** excel 2 json
      - 实现配置转换工具
      - 支持配置热更新
      - 实现配置版本管理
    - 实现配置中心
    - 支持配置动态加载
    - 实现配置校验

**要点和思考方向：**
- 数据库系统要平衡性能和资源使用
- 日志系统要支持海量数据处理和快速查询
- 配置系统要支持热更新和版本管理

### Actor模型

**是什么？在哪用？**

- **作用**：轻量级进程+分布式计算+基于消息的编程模型
- **应用场景**：
  - 封闭性高的系统
  - 高并发场景
  - 分布式系统
- **做什么的？** 轻量级进程+分布式计算+基于消息的编程模型。
- **在哪用？** 封闭性高的系统。

**会遇到哪些问题？用什么解决？**

- **什么时候使用Actor模型？**
  - **问题**：需要判断是否适合使用Actor模型
  - **解决方向**：
    - **适用性：** 封闭性高的系统
      - 系统内部状态封闭
      - 通过消息通信
      - 避免共享状态
    - **应用场景：**
      - **玩家数据：** 每个玩家一个Actor
        - 隔离玩家数据
        - 避免数据竞争
        - 简化并发处理
      - **公会：** 每个公会一个Actor
        - 管理公会数据
        - 处理公会操作
        - 避免并发冲突
      - **排行榜：** 排行榜Actor
        - 管理排行榜数据
        - 处理排行榜更新
        - 保证数据一致性
      - **房间：** 每个房间一个Actor
        - 管理房间状态
        - 处理房间操作
        - 隔离房间数据

- **如何实现Actor模型？**
  - **问题**：需要实现Actor模型系统
  - **解决方向**：
    - **特性：**
      - **分布式计算：** 支持分布式部署
        - 实现Actor路由
        - 支持跨节点通信
        - 实现负载均衡
      - **可伸缩：** 支持动态扩展
        - 动态创建Actor
        - 支持Actor迁移
        - 实现资源管理
      - **无锁化编程：** 避免锁竞争
        - 使用消息队列
        - 避免共享状态
        - 实现消息顺序处理
      - **集群化管理：** 支持集群部署
        - 实现Actor发现
        - 支持故障转移
        - 实现负载均衡
      - **代码无割裂：** 保持代码完整性
        - 统一的消息处理
        - 清晰的Actor边界
        - 简化的并发模型
    - **实现：**
      - **actor system：** Actor系统框架
        - 管理Actor生命周期
        - 处理消息路由
        - 实现Actor调度
      - **go routine池：** 使用协程池
        - 管理协程资源
        - 控制并发数量
        - 提高资源利用率
      - **message handler：** 消息处理器
        - 处理Actor消息
        - 实现消息分发
        - 支持消息过滤
      - **context：** 上下文管理
        - 传递上下文信息
        - 管理Actor状态
        - 实现超时控制

**要点和思考方向：**
- **特性：**
  - 分布式计算
  - 可伸缩
  - 无锁化编程
  - 集群化管理
  - 代码无割裂
- **适用性：** 封闭性高的系统
- **应用场景：**
  - 玩家数据
  - 公会
  - 排行榜
  - 房间
- **实现：**
  - actor system
  - go routine池
  - message handler
  - context

### 测试

**是什么？在哪用？**

- **作用**：各种测试方法和工具
- **应用场景**：
  - 开发和上线阶段
  - 功能验证
  - 性能评估
  - 问题排查
- **做什么的？** 各种测试方法和工具。
- **在哪用？** 开发和上线阶段。

**会遇到哪些问题？用什么解决？**

- **如何进行压力测试？**
  - **问题**：需要评估服务器在高负载下的表现
  - **解决方向**：
    - **压力测试：** 模拟大量玩家同时访问游戏服务器的情况，通过测试服务器的性能、稳定性和可扩展性等指标，评估服务器在实际运行环境中的表现
      - 模拟真实玩家行为
      - 监控性能指标
      - 分析性能瓶颈
    - **测试用例：**
      - **并发用户数：** 测试不同并发下的表现
        - 逐步增加并发数
        - 监控性能变化
        - 找到性能拐点
      - **请求频率：** 测试不同请求频率下的表现
        - 模拟不同请求频率
        - 监控响应时间
        - 分析性能影响
      - **网络延迟：** 测试不同网络延迟下的表现
        - 模拟不同网络延迟
        - 测试容错能力
        - 优化网络处理
    - 使用压力测试工具
    - 建立性能基线
    - 定期进行压力测试

- **如何进行接口测试？**
  - **问题**：需要快速测试功能接口
  - **解决方向**：
    - **接口测试：** 快速测试功能接口的工具，能大幅提高开发效率
      - 自动化测试
      - 快速验证功能
      - 提高开发效率
    - 使用接口测试工具（如Postman、JMeter）
    - 实现自动化测试脚本
    - 建立测试用例库
    - 实现持续集成测试

- **单元测试**
  - **问题**：需要测试单个功能模块
  - **解决方向**：
    - **单元测试：** 测试单个功能模块
      - 测试函数功能
      - 验证逻辑正确性
      - 提高代码质量
    - 使用单元测试框架
    - 实现测试覆盖率
    - 建立测试规范

**要点和思考方向：**
- 压力测试是评估服务器性能的重要手段
- 接口测试能大幅提高开发效率
- 单元测试保证代码质量
- 建立完善的测试体系

### 更新

**是什么？在哪用？**

- **作用**：服务端更新和热更新机制
- **应用场景**：
  - 游戏运营和维护阶段
  - 版本更新
  - 功能修复
  - 配置更新
- **做什么的？** 服务端更新和热更新机制。
- **在哪用？** 游戏运营和维护阶段。

**会遇到哪些问题？用什么解决？**

- **如何实现不停服更新？**
  - **问题**：需要在不中断服务的情况下更新服务器
  - **解决方向**：
    - **不停服更新：**
      - **蓝绿更新：** 相当于双份环境，一个运行版本、一个更新版本
        - 优点：零停机时间、快速回滚
        - 缺点：需要双倍资源
        - 实现：准备新环境、切换流量、验证后下线旧环境
      - **灰度更新：** 让集群中的环境部分更新，没有问题了其它环境跟上
        - 优点：风险可控、逐步验证
        - 缺点：更新周期较长
        - 实现：部分节点更新、验证、逐步推广
      - **滚动更新：** 不中断业务，逐个服务模块更新
        - 优点：资源占用少、更新平滑
        - 缺点：更新周期较长
        - 实现：逐个节点更新、保持服务可用
    - 实现版本管理
    - 实现流量切换
    - 实现回滚机制
    - 监控更新过程

- **如何实现代码热更新？**
  - **问题**：需要在不重启服务的情况下更新代码
  - **解决方向**：
    - **代码热更新：**
      - **Lua脚本：** 参考框架 - skynet
        - 使用脚本语言实现热更新
        - 动态加载脚本
        - 支持运行时更新
      - 使用脚本语言（Lua、Python等）
      - 实现动态加载机制
      - 支持代码版本管理
      - 实现安全的热更新流程

- **更新管理**
  - **问题**：需要管理更新流程和配置
  - **解决方向**：
    - **白名单：** 需要设定白名单，让测试号/IP，可以进入服务测试
      - 实现白名单机制
      - 支持测试环境隔离
      - 实现权限控制
    - **配置管理：** 管理服务器配置
      - 实现配置中心
      - 支持配置热更新
      - 实现配置版本管理
    - 实现更新审批流程
    - 实现更新日志记录
    - 实现更新回滚机制

**要点和思考方向：**
- 不停服更新是保证服务可用性的重要手段
- 选择合适的更新策略很重要
- 代码热更新可以提高更新效率
- 建立完善的更新管理流程

### 服务器管理

**是什么？在哪用？**

- **作用**：服务器的维护和管理功能
- **应用场景**：
  - 服务器运维阶段
  - 服务器监控
  - 服务器维护
  - 服务器扩展
- **做什么的？** 服务器的维护和管理功能。
- **在哪用？** 服务器运维阶段。

**会遇到哪些问题？用什么解决？**

- **如何管理服务器维护？**
  - **问题**：需要管理服务器的维护操作
  - **解决方向**：
    - **服务器维护：**
      - **更新：** 管理服务器更新
        - 实现更新流程
        - 支持版本管理
        - 实现回滚机制
      - **重启：** 管理服务器重启
        - 实现优雅重启
        - 支持批量重启
        - 实现重启计划
      - **状态查询：** 查询服务器状态
        - 实现状态监控
        - 支持实时查询
        - 实现状态告警
      - **扩容：** 管理服务器扩容
        - 实现自动扩容
        - 支持手动扩容
        - 实现资源管理

- **如何管理日志？**
  - **问题**：需要管理和查询服务器日志
  - **解决方向**：
    - **日志：**
      - **查询：** 查询服务器日志
        - 实现日志搜索
        - 支持条件查询
        - 实现日志导出
      - **实时查看：** 实时查看服务器日志
        - 实现日志流式输出
        - 支持日志过滤
        - 实现日志高亮
    - 使用日志管理系统
    - 实现日志聚合
    - 实现日志分析

- **如何管理配置？**
  - **问题**：需要管理服务器配置
  - **解决方向**：
    - **配置：** 配置管理
      - 实现配置中心
      - 支持配置热更新
      - 实现配置版本管理
      - 支持配置校验
    - 实现配置模板
    - 支持批量配置
    - 实现配置审计

- **服务器监控和管理**
  - **问题**：需要监控和管理服务器
  - **解决方向**：
    - 实现服务器监控
    - 实现性能监控
    - 实现告警机制
    - 实现自动化运维
    - 实现资源管理

**要点和思考方向：**
- 服务器管理是运维的基础工作
- 实现自动化管理提高效率
- 建立完善的监控和告警体系
- 支持批量操作和自动化运维

## 更多资料