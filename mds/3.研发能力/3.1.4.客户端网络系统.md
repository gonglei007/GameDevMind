<h2 align="center">客户端网络系统</h2>
<p>
客户端的网络不仅仅是连接和收发消息。我们还要做更多的事情来保障一个易用的、高效的、稳定的、有良好体验的网络系统。一个完善的网络系统需要考虑协议选择、域名解析、消息处理、异常处理、并发控制等多个方面。
</p>

**关键词:**<br/>
*客户端网络系统,重连,压缩,并发,DNS,HTTP,Socket,WebSocket,超时,多线程,域名解析,HTTP DNS,IPv6,多连接通道,消息压缩,Protobuf,GZip,状态管理,事件接口,桥接接口,异常处理,连接失败,连接断开,定时重试,Buffer,缓冲区,Best HTTP*

**标签:**<br/>
*等级: 中级|高级, 阶段: 开发, 分类: 研发能力, 角色: 客户端开发*

## 图谱
![图片加载中...](../../exports/3.1.4.客户端网络系统.png)

## 系统概览

### 目标

**是什么？在哪用？**

- **作用**：提供一个易用的、高效的、稳定的、有良好体验的网络系统
- **应用场景**：
  - 所有需要网络通信的游戏功能
  - 用户登录认证
  - 游戏数据同步
  - 实时对战
  - 聊天系统
- **做什么的？** 提供一个易用的、高效的、稳定的、有良好体验的网络系统。
- **在哪用？** 所有需要网络通信的游戏功能。

### 协议

**是什么？在哪用？**

- **作用**：选择合适的网络协议进行通信
- **应用场景**：
  - 根据游戏需求选择短连接或长连接
  - 用户账户系统
  - 支付系统
  - 实时对战
  - 聊天系统
- **做什么的？** 选择合适的网络协议进行通信。
- **在哪用？** 根据游戏需求选择短连接或长连接。

**会遇到哪些问题？用什么解决？**

- **什么时候用短连接，什么时候用长连接？**
  - **问题**：需要根据游戏需求选择合适的连接方式
  - **解决方向**：
    - **短连接（HTTP/HTTPS）：**
      - 用于弱交互的游戏或系统
      - 对交互的实时性要求不高的游戏
      - 例如用户账户系统、支付系统、周边的api等
    - **长连接（Socket、WebSocket、Socket.io）：**
      - 用于交互较强的游戏或系统功能
      - 需要实时通信的场景

- **如何扩展协议以满足游戏特定需求？**
  - **问题**：标准协议需要扩展以满足游戏特定需求
  - **解决方向**：
    - **短连接协议扩展：**
      - 在消息请求头中封装通用信息
      - 例如：uid、channel、鉴权信息、时间戳
    - **长连接协议扩展：**
      - 实现心跳机制（用于检查客户端连接状态）
      - 添加uid、channel、时间戳等信息

**要点和思考方向：**

**短连接：**
- **HTTP/HTTPS：** 无状态协议
- **主要需要支持：**
  - Post
  - Get
  - Download（并发下载）
- **协议扩展：** 所有游戏产品的消息请求都会附带一些通用信息，可以把这些信息头封装进去
  - **举例：** uid、channel、鉴权信息、时间戳
- **应用：**
  - 通常用于弱交互的游戏或系统，有些对交互的实时性要求不高的游戏，也可以使用
  - 例如用户账户系统、支付系统、周边的 api 等

**长连接：**
- **Socket、WebSocket、Socket.io**
- **应用：** 用于交互较强的游戏或系统功能
- **协议扩展：**
  - 心跳（用于检查客户端的连接状态）
  - uid、channel、时间戳

### 域名解析

**是什么？在哪用？**

- **作用**：优化域名解析，提高网络连接成功率和质量
- **应用场景**：
  - 所有网络请求的初始阶段
  - 游戏服务器连接
  - API请求
- **做什么的？** 优化域名解析，提高网络连接成功率和质量。
- **在哪用？** 所有网络请求的初始阶段。

**会遇到哪些问题？用什么解决？**

- **如何提高域名解析的成功率？**
  - **问题**：域名解析可能失败，影响连接成功率
  - **解决方向**：
    - 支持域名多IP解析，当解析后的一个IP无法联通，就尝试下一个
    - 能够解析出来IPv4和IPv6
    - 实现域名解析缓存
    - 使用HTTP DNS提高解析成功率

- **如何防止域名劫持？**
  - **问题**：域名可能被劫持，影响网络质量
  - **解决方向**：
    - 实现HTTP DNS来解析域名，防止域名劫持
    - 从HTTP DNS服务获取域名的解析结果
    - 如果解析不成功，直接使用本地解析
    - 支持多域名，测试域名列表里的各个域名，选择更优质的域名使用

- **如何支持 IPv6？**
  - **问题**：需要支持IPv6以满足合规要求
  - **解决方向**：
    - 能够解析出来IPv4和IPv6
    - 由于苹果的合规要求，网络系统是要支持IPv6的
    - 实现IPv6连接支持
    - 测试IPv6连接质量

**要点和思考方向：**

**1. 支持域名多 IP 解析：**
- 当解析后的一个 IP 无法联通，就尝试下一个
- 能够解析出来 IPv4 和 IPv6
  - 由于苹果的合规要求，网络系统是要支持 IPv6 的

**2. HTTP DNS：**
- 如果追求更高质量、更稳定的网络，防止个别地区有域名劫持的情况，就要实现通过 HTTP DNS 来解析域名
- **解析：** 从 HTTP DNS 服务获取域名的解析结果。如果解析不成功，直接使用本地解析
- **缓存：**
  - 域名的解析结果不要每次请求都去解析，先解析好后，在本地缓存下来
  - TTL：解析的地址不一定会长期有效，所以在本地根据 TTL 来重新请求并缓存解析结果

**3. 多域名支持：**
- 如果还有进一步网络质量的需求，可以考虑支持多域名
- 先测试域名列表里的各个域名，哪个域名更优质，就选择哪个域名使用

### 多连接通道

**是什么？在哪用？**

- **作用**：支持游戏中建立多条长连接
- **应用场景**：
  - 需要多个独立网络通道的场景
  - 某些子游戏玩法
  - 聊天系统
  - 多服务器连接
- **做什么的？** 支持游戏中建立多条长连接。
- **在哪用？** 需要多个独立网络通道的场景。

**会遇到哪些问题？用什么解决？**

- **如何管理多条连接？**
  - **问题**：多条连接需要统一管理
  - **解决方向**：
    - 实现连接管理器
    - 支持连接的创建、销毁、复用
    - 实现连接状态管理
    - 优化连接资源使用

- **如何避免连接冲突？**
  - **问题**：多条连接可能产生冲突
  - **解决方向**：
    - 为每条连接分配独立标识
    - 实现连接隔离
    - 处理连接优先级
    - 优化连接调度

**要点和思考方向：**
- **应用举例：**
  - 某些子游戏玩法
  - 聊天系统
- 考虑连接管理和资源优化
- 实现连接隔离和优先级管理

### 消息

**是什么？在哪用？**

- **作用**：消息的压缩和传输优化
- **应用场景**：
  - 所有网络消息的发送和接收
  - 游戏数据同步
  - 实时通信
- **做什么的？** 消息的压缩和传输优化。
- **在哪用？** 所有网络消息的发送和接收。

**会遇到哪些问题？用什么解决？**

- **如何减少消息传输的数据量？**
  - **问题**：消息数据量大影响传输速度和体验
  - **解决方向**：
    - 使用消息压缩
    - 优化消息格式
    - 减少不必要的字段
    - 使用增量更新
    - 实现消息缓存

- **如何平衡压缩效率和开发效率？**
  - **问题**：不同压缩方案有不同优缺点
  - **解决方向**：
    - **Protobuf：**
      - 开发调试相对繁琐一些
      - 压缩率和效率都更高
    - **GZip：**
      - 开发调试简单一些
      - 效率相对低点
    - 根据项目需求选择合适的方案

**要点和思考方向：**
- **压缩作用：** 有些消息（服务器返回的消息）的数据量可能非常大，这样在网络环境差一点的时候，就可能会很慢或者超时，或者消耗更大的流量和电量，造成不好的体验。所以需要对部分/或者全部消息进行压缩后的收发
- **方法：**
  - **Protobuf：**
    - 开发调试相对繁琐一些
    - 压缩率和效率都更高
  - **GZip：**
    - 开发调试简单一些
    - 效率相对低点

### 状态管理

**是什么？在哪用？**

- **作用**：管理网络系统的各种状态
- **应用场景**：
  - 网络系统的状态监控和处理
  - 连接状态管理
  - 网络异常处理
- **做什么的？** 管理网络系统的各种状态。
- **在哪用？** 网络系统的状态监控和处理。

**会遇到哪些问题？用什么解决？**

- **如何管理网络状态？**
  - **问题**：网络系统有多种状态，需要统一管理
  - **解决方向**：
    - 定义网络状态枚举（连接中、已连接、断开、重连中等）
    - 实现状态机管理状态转换
    - 记录状态变化历史
    - 实现状态通知机制

- **如何处理状态转换？**
  - **问题**：状态转换需要合理处理
  - **解决方向**：
    - 定义状态转换规则
    - 实现状态进入、退出、更新接口
    - 处理异常状态转换
    - 优化状态转换性能

**要点和思考方向：**
- 游戏的网络可能处于多种状态，需要有状态的记录和针对不同状态的处理
- 使用状态机管理网络状态
- 实现状态通知机制

### 事件接口

**是什么？在哪用？**

- **作用**：提供完善的事件接口，让其他系统了解网络状态
- **应用场景**：
  - 需要响应网络状态变化的系统
  - 游戏系统
  - UI系统
  - 日志系统
- **做什么的？** 提供完善的事件接口，让其他系统了解网络状态。
- **在哪用？** 需要响应网络状态变化的系统。

**会遇到哪些问题？用什么解决？**

- **如何设计事件接口？**
  - **问题**：需要设计完善的事件接口
  - **解决方向**：
    - 定义事件类型（连接成功、连接失败、断开连接、消息接收等）
    - 实现事件订阅和发布机制
    - 支持事件参数传递
    - 实现事件优先级
    - 优化事件性能

- **如何确保事件及时通知？**
  - **问题**：事件需要及时通知到相关系统
  - **解决方向**：
    - 使用观察者模式实现事件通知
    - 实现异步事件处理
    - 优化事件分发性能
    - 处理事件丢失情况

**要点和思考方向：**
- **作用：** 有完善的事件接口，才能让其它各个系统及时了解到网络系统的状态，做出响应的响应
- **举例：**
  - **网络断线：** 游戏系统监测到后触发重连流程
  - **请求异常：** 游戏系统监测到后可上报日志
- 使用观察者模式实现事件系统
- 优化事件性能

### 桥接接口

**是什么？在哪用？**

- **作用**：网络系统与其他系统的解耦接口
- **应用场景**：
  - 需要网络系统与其他系统交互的场景
  - UI系统交互
  - 日志系统交互
  - 游戏系统交互
- **做什么的？** 网络系统与其他系统的解耦接口。
- **在哪用？** 需要网络系统与其他系统交互的场景。

**会遇到哪些问题？用什么解决？**

- **如何设计桥接接口？**
  - **问题**：需要设计解耦的桥接接口
  - **解决方向**：
    - 使用接口抽象实现解耦
    - 定义桥接接口规范
    - 实现接口适配器
    - 支持接口扩展
    - 优化接口性能

- **如何管理桥接接口？**
  - **问题**：多个桥接接口需要统一管理
  - **解决方向**：
    - 实现桥接接口管理器
    - 支持接口注册和注销
    - 实现接口优先级
    - 优化接口调用性能

**要点和思考方向：**
- **说明：** 网络系统的一些行为和结果，可能会需要反馈到其它系统中。为了解耦，需要做相关的桥接接口
- **举例：**
  - **UI 相关的回调接口：**
    - 弹消息确认框
    - 显示网络等待
  - **日志相关的回调接口：**
    - 上报数据
- 使用接口抽象实现解耦
- 实现桥接接口管理

### 异常处理

**做什么的？** 对各种网络异常进行合理响应及处理。

**在哪用？** 所有网络操作可能出现异常的场景。

**会遇到哪些问题？**
- 如何处理连接失败？
- 如何处理连接断开？
- 如何处理各种异常情况？

**要点和思考方向：**
- **异常类型：** 域名问题、网络问题、后端服务问题、业务逻辑问题
- **连接失败：** 连接失败后要能自动重试，多次尝试不成功后给出提示，让用户选择重试
- **连接断开：** 连接断开后要有提示，让玩家可以触发重连。出于网络数据同步考虑，重连后需要重新同步一下数据
- **异常处理：** 要提供连接或者发送消息请求失败后的处理机制
- **响应方式：**
  - **定时自动重试（N 次）：** 第 1、2、3...次的重试时间逐渐拉长（比如用斐波那契数列）
  - **弹框提醒：** 让用户自己确认重试
  - **忽略：** 可能被用于日志上报等类型的消息请求

### 多线程

**是什么？在哪用？**

- **作用**：将网络操作放到子线程，避免阻塞主线程
- **应用场景**：
  - 所有网络操作
  - 网络请求发送
  - 网络响应接收
  - 文件下载
- **做什么的？** 将网络操作放到子线程，避免阻塞主线程。
- **在哪用？** 所有网络操作。

**会遇到哪些问题？用什么解决？**

- **如何在子线程中处理网络操作？**
  - **问题**：需要在子线程中处理网络操作
  - **解决方向**：
    - 创建独立的网络线程
    - 实现网络操作队列
    - 使用线程池管理网络线程
    - 优化线程资源使用
    - 处理线程异常

- **如何将结果传回主线程？**
  - **问题**：网络操作结果需要传回主线程
  - **解决方向**：
    - 返回的消息的callback要传回到主线程中
    - 否则在子线程中不能正常操作UI的方法
    - 使用消息队列传递结果
    - 实现线程安全的结果传递
    - 优化线程间通信性能

- **线程安全**
  - **问题**：多线程操作需要保证线程安全
  - **解决方向**：
    - 使用锁机制保护共享资源
    - 避免竞态条件
    - 实现线程安全的数据结构
    - 优化锁性能

**要点和思考方向：**
- **作用：** 如果在主线程处理网络消息，当消息响应时间很长时，就会造成同在主线程的 UI 的卡顿。所以需要把网络相关的操作实现到子线程中
- **注意：**
  - 返回的消息的 callback 要传回到主线程中，否则在子线程中不能正常操作 UI 的方法
  - 线程安全

### 并发

**做什么的？** 处理并发请求，避免并发问题。

**在哪用？** 用户可能快速连续操作触发多个网络请求的场景。

**会遇到哪些问题？**
- 如何防止用户快速点击造成的并发问题？
- 如何处理消息的时序问题？

**要点和思考方向：**
- **问题：** 如果没有对玩家的操作进行限制，玩家可以随意快速点击界面，由于网络的延迟性和异步性，就有可能造成并发问题
- **说明：** 解决并发问题可能需要网络系统、业务层、服务端等都要进行处理。这里仅仅是说（通用）网络系统层可以处理的点
- **方案：**
  - **交互层：**
    - **弹出遮罩：** 为了减少并发产生的问题的几率，可以对用户的操作有一定限制。就是当一个消息发出的时候，就在 UI 最上层盖上一层遮罩（Collider），让用户不能跟 UI 交互（触发新的网络请求）
    - **隐藏遮罩：** 当消息请求被响应并返回结果后，隐藏遮罩。不管响应是成功还是失败，也不管是哪种失败，都要隐藏掉遮罩
    - **交互体验：**
      - **遮罩表现：** 为了好点的体验，遮罩不可见，但可以加些动态效果（2D 动画/旋转的 Sprite 等）。这个动画不要立即弹出，要有一定的延迟（比如 1 秒）。这样画面就不会老被干扰，又不会因为长时间等待无法操作感觉像被卡死了
      - **适用场景：** 如果一个页面有交互功能，在操作这个功能的时候，就可以考虑使用网络请求遮罩。如果是在加载页面这种没有交互功能的页面，可以不用额外加这个遮罩
  - **网络层：**
    - 网络消息的发送和响应的时序要一致
    - **问题：** 要考虑一下，一个后发的消息先返回了，要不要先处理它。如果不先处理，要怎么等待和处理前置的消息？

### 传输

**是什么？在哪用？**

- **作用**：处理网络传输的缓冲和超时机制
- **应用场景**：
  - 所有网络数据传输
  - HTTP请求
  - 文件下载
  - 实时通信
- **做什么的？** 处理网络传输的缓冲和超时机制。
- **在哪用？** 所有网络数据传输。

**会遇到哪些问题？用什么解决？**

- **如何设置合适的超时时间？**
  - **问题**：超时时间设置影响用户体验
  - **解决方向**：
    - 综合体验和功能考虑，找到适合游戏的超时时长设置
    - 不同类型的游戏，找到更好体验的超时设置
    - **消息：**
      - 连接超时：推荐3s
      - 请求超时：推荐1.2s
    - **下载：**
      - 链接超时：推荐15s
      - 请求超时：推荐5s
    - 支持动态调整超时时间

- **如何处理传输速率不匹配的问题？**
  - **问题**：客户端和服务器传输速率可能不匹配
  - **解决方向**：
    - 使用Buffer缓解传输速率不匹配
    - 实现动态缓冲区大小调整
    - 优化缓冲区管理
    - 处理缓冲区溢出

- **Buffer管理**
  - **问题**：Buffer需要合理管理
  - **解决方向**：
    - 实现Buffer池管理
    - 优化Buffer分配和释放
    - 处理Buffer大小和超时设置的关系
    - 考虑基于当前网络的实际速率x超时时间，是否能填满Buffer

**要点和思考方向：**

**Buffer：**
- **说明：** 用于存储传输中的数据，包括请求和响应消息
- **作用：**
  - **存储请求消息：** 客户端发送 HTTP 请求时，请求消息的内容需要存储在缓冲区中，以便在整个请求传输完成之前保持数据完整性
  - **存储响应消息：** 服务器接收到客户端的请求后，需要将响应消息的内容存储在缓冲区中，然后再发送给客户端
  - **缓解传输速率不匹配：** 在 HTTP 通信中，客户端和服务器之间的数据传输速率可能不匹配。使用缓冲区可以缓解这种速率不匹配带来的问题
  - **提高性能：** 使用适当大小的缓冲区可以减少网络通信的次数，从而提高通信性能
  - **处理并发请求：** 在服务器端，缓冲区可以用于存储并发请求的数据，以便逐个处理

**超时：**
- **说明：** 综合体验和功能考虑，找到适合游戏的超时时长设置。不同类型的游戏，找到更好体验的超时设置
- **超时的判断：** 从 Buffer 开始接收数据，到接收完成或者填满，所用的时间
- **作用：** 如果一个网络请求长时间无法获得结果，就应该结束这个请求，否则就会影响到游戏的体验，比如有卡死的感觉
- **消息：**
  - **连接超时：** 推荐 3s
  - **请求超时：** 推荐 1.2s
- **下载：**
  - **链接超时：** 推荐 15s
  - **请求超时：** 推荐 5s
- **问题：** 由于超时的判断机制，使得缓冲区大小和超时设置，会决定所支持的最低下载速率。也就是要考虑，基于当前网络的实际速率 x 超时时间，是否能填满 Buffer，如果不能，就会造成超时

### 中间件

**是什么？在哪用？**

- **作用**：可用的网络中间件和框架
- **应用场景**：
  - 需要快速搭建网络系统的项目
  - 新项目启动
  - 网络系统重构
- **做什么的？** 可用的网络中间件和框架。
- **在哪用？** 需要快速搭建网络系统的项目。

**会遇到哪些问题？用什么解决？**

- **如何选择合适的中间件？**
  - **问题**：需要选择合适的网络中间件
  - **解决方向**：
    - 评估中间件的功能完整性
    - 考虑中间件的性能和稳定性
    - 评估中间件的学习成本
    - 考虑中间件的维护和支持
    - 测试中间件的兼容性

- **如何使用中间件？**
  - **问题**：需要正确使用中间件
  - **解决方向**：
    - 学习中间件的使用方法
    - 建立中间件使用规范
    - 实现中间件封装
    - 优化中间件配置
    - 处理中间件异常

**要点和思考方向：**
- **候选：** Best HTTP (Pro)
- **思考：** 前面的特性支持的越完备，将来随着产品的深入开发，你自己需要去处理的事情就越少
- 根据项目需求选择合适的中间件
- 建立中间件使用规范

## 更多资料
### 文章
* [HTTPDNS解析](https://zhuanlan.zhihu.com/p/102839806) - 一篇关于HTTP DNS解析的介绍文章。 
* [客户端网络优化(一) - 原理篇](https://juejin.cn/post/6992146752077824031) - 一篇关于客户端网络优化的文章。
### 中间件
* [GGFramework.GGNetwork(内测版)](https://github.com/gonglei007/GGFramework-GGNetwork) - 一个游戏客户端网络框架，为你的游戏项目提供了网络稳定性和体验增强的能力。