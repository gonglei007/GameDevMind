<h2 align="center">物理</h2>
<p>
真实的物理表现会给游戏带来真实的体验感。我们来看一下游戏开发中的物理所要考虑的一些事情。
</p>

**关键词:**<br/>
*刚体,碰撞体,Collider,触发器,Trigger,力,软体,AABB,Physx,Bullet,Havok*

**标签:**<br/>
*等级: 中级, 阶段: 学习|开发, 分类: 技术能力, 角色: 客户端开发|美术*

----
## 刚体

**是什么？在哪用？**
- **作用**：
  - 表现物体的质量
  - 表现物体的碰撞
  - 模拟物体的物理行为
- **应用场景**：
  - 可移动的游戏对象（角色、道具、车辆等）
  - 需要物理交互的物体
  - 受力和碰撞影响的物体
- **属性**：
  - **质量**：影响物体的惯性和受力响应
  - **弹性**：影响碰撞后的反弹程度
  - **阻尼**：影响物体的运动衰减
  - **角速度**：影响物体的旋转

**会遇到哪些问题？用什么解决？**
- **性能问题**
  - **问题**：大量刚体导致物理计算开销大
  - **解决方向**：
    - 限制同时激活的刚体数量
    - 使用静态碰撞体替代动态刚体（如果可能）
    - 使用物理LOD（远距离简化物理计算）
    - 合并小物体

- **不稳定问题**
  - **问题**：刚体可能出现抖动、穿透等不稳定现象
  - **解决方向**：
    - 调整物理时间步长
    - 使用连续碰撞检测
    - 限制刚体速度
    - 使用固定时间步长

- **质量设置问题**
  - **问题**：质量设置不当导致物理行为不真实
  - **解决方向**：
    - 根据物体大小和材质设置合理的质量
    - 避免质量差异过大
    - 使用质量中心（Center of Mass）调整

**要点和思考方向**
- 刚体是物理模拟的基础
- 质量影响物体的惯性和受力响应
- 合理设置刚体属性可以获得真实的物理效果
- 注意性能，避免过多动态刚体
- 静态物体不需要刚体，使用静态碰撞体即可

## 速度

**是什么？在哪用？**
- **作用**：让物体获得一个速度，控制物体的运动
- **应用场景**：
  - 移动的游戏对象
  - 抛射物
  - 车辆运动
  - 角色移动
- **特性**：
  - 速度是个向量（有大小和方向）
  - 速度会受到碰撞和力的影响
  - 速度可以叠加

**会遇到哪些问题？用什么解决？**
- **速度突变**
  - **问题**：直接设置速度可能导致运动不自然
  - **解决方向**：
    - 使用力来改变速度（更自然）
    - 平滑插值速度变化
    - 限制加速度

- **速度过大**
  - **问题**：速度过大可能导致穿透问题
  - **解决方向**：
    - 限制最大速度
    - 使用连续碰撞检测
    - 增加物理更新频率

- **速度控制**
  - **问题**：精确控制物体速度困难
  - **解决方向**：
    - 使用速度阻尼
    - 使用力来控制速度
    - 直接设置速度（如果精确控制需要）

**要点和思考方向**
- 速度是向量，有大小和方向
- 直接设置速度可能导致不自然的运动
- 使用力来改变速度通常更自然
- 注意速度限制，避免穿透问题
- 速度会受到碰撞和力的影响

## 力与加速度

**是什么？在哪用？**
- **作用**：通过施加力来改变物体的运动状态，实现真实的物理效果
- **应用场景**：
  - 物体运动控制
  - 物理交互
  - 特效和粒子
- **原理**：根据牛顿第二定律 F = ma，力产生加速度，加速度改变速度

## 加速度来源

- **施加在刚体上的力产生加速度**：通过施加力来改变物体的运动状态
  - **瞬时力**：一次性施加的力（如爆炸、冲击）
  - **持续力**：持续施加的力（如推力、牵引力）

- **全局加速度**
  - **重力**
    - **作用**：提供一个全局的方向统一的力
    - **应用**：模拟地球重力，让物体下落

## 应用举例

- **粒子系统**：可用在粒子系统中粒子的表现

- **自然系统**：可用在自然系统的事物的表现。例如随风飘落的雪花

- **汽车的驱动**：模拟车辆的动力系统

- **抛出去的物体**：模拟抛射物的运动轨迹

- **物体在水中行进的阻力表现**：模拟流体阻力

**会遇到哪些问题？用什么解决？**
- **力的大小控制**
  - **问题**：力的大小难以精确控制
  - **解决方向**：
    - 根据质量调整力的大小
    - 使用力系数
    - 测试和调整

- **力的叠加**
  - **问题**：多个力同时作用可能导致意外的运动
  - **解决方向**：
    - 理解力的叠加原理
    - 合理设计力的作用时机
    - 使用力的优先级

- **性能问题**
  - **问题**：频繁施加力可能导致性能问题
  - **解决方向**：
    - 限制同时作用的力数量
    - 使用力池（Force Pool）
    - 优化力的计算

**要点和思考方向**
- 力是改变物体运动状态的方式
- 使用力比直接设置速度更自然
- 重力是全局加速度，影响所有刚体
- 理解力的叠加原理
- 注意力的性能开销

## 碰撞

**是什么？在哪用？**
- **作用**：检测和处理物体之间的接触和交互
- **应用场景**：
  - 物理阻挡
  - 碰撞检测
  - 触发事件
  - 物理交互

## 碰撞体（Collider）

**是什么？在哪用？**
- **作用**：产生物理阻挡、碰撞效果
- **应用场景**：
  - 物理阻挡（墙壁、地面等）
  - 碰撞检测
  - 物理交互
- **类型**：
  - **Box Collider**：盒形碰撞体，性能好
  - **Sphere Collider**：球形碰撞体，性能好
  - **Capsule Collider**：胶囊形碰撞体，适合角色
  - **Mesh Collider**：网格碰撞体，精确但性能差
  - **Compound Collider**：复合碰撞体，组合多个简单碰撞体

**会遇到哪些问题？用什么解决？**
- **碰撞体选择**
  - **问题**：如何选择合适的碰撞体类型
  - **解决方向**：
    - 简单形状使用简单碰撞体（Box、Sphere等）
    - 复杂形状使用复合碰撞体
    - 避免使用Mesh Collider（性能差）
    - 根据精度需求选择

- **碰撞体大小**
  - **问题**：碰撞体大小不当导致穿透或检测不准确
  - **解决方向**：
    - 碰撞体应该略大于或等于模型大小
    - 测试和调整碰撞体大小
    - 使用可视化工具查看碰撞体

**要点和思考方向**
- 碰撞体用于物理阻挡和碰撞检测
- 简单碰撞体性能好，复杂碰撞体性能差
- 合理选择碰撞体类型可以平衡性能和精度
- 避免使用Mesh Collider，使用复合碰撞体替代

## 触发器（Trigger）

**是什么？在哪用？**
- **作用**：用于检测到物体发生接触或者交叉了
- **应用场景**：
  - 触发事件（进入区域、拾取物品等）
  - 检测物体进入/离开区域
  - 不需要物理阻挡的检测
- **特点**：不产生物理阻挡，只检测接触

**会遇到哪些问题？用什么解决？**
- **触发时机**
  - **问题**：触发事件可能被多次触发
  - **解决方向**：
    - 使用标志位防止重复触发
    - 使用进入/离开事件区分
    - 使用时间间隔限制

- **性能问题**
  - **问题**：大量触发器可能导致性能问题
  - **解决方向**：
    - 限制触发器数量
    - 使用空间分割优化
    - 及时禁用不需要的触发器

**要点和思考方向**
- 触发器用于检测接触，不产生物理阻挡
- 适合用于触发事件和区域检测
- 注意触发事件的重复触发问题
- 合理使用触发器可以提高游戏体验

## 碰撞检测模式

**是什么？在哪用？**
- **作用**：控制碰撞检测的精度和性能
- **应用场景**：
  - 根据物体速度选择合适的检测模式
  - 平衡性能和精度
- **Discrete（离散检测）**
  - **优点**：性能好
  - **问题**：物体速度较快时可能会穿过另一碰撞物体
  - **应用**：慢速移动的物体

- **Continuous（连续检测）**
  - **说明**：连续的碰撞检测，保证物体不会穿过其它碰撞体。但性能较低
  - **应用**：快速移动的物体

- **Continuous dynamic（连续动态检测）**
  - **应用**：针对静态网格碰撞器（不带刚体），用于快速移动的物体
  - **说明**：最高精度的检测，但性能开销最大

**会遇到哪些问题？用什么解决？**
- **快速移动物体穿透**
  - **问题**：两个快速移动的碰撞体，可能会相互穿过而检测不到碰撞。这是因为两帧计算碰撞体已经错过了相交位置
  - **解决方向**：
    - 使用连续碰撞检测（Continuous）
    - 限制物体最大速度
    - 增加物理更新频率
    - 使用连续动态检测（Continuous Dynamic）

- **性能与精度平衡**
  - **问题**：连续检测性能开销大
  - **解决方向**：
    - 只对快速移动的物体使用连续检测
    - 慢速物体使用离散检测
    - 根据实际需求选择合适的模式

**要点和思考方向**
- 离散检测性能好但可能穿透
- 连续检测精度高但性能开销大
- 根据物体速度选择合适的检测模式
- 只对需要的物体使用连续检测
- 合理平衡性能和精度

## 算法

**是什么？在哪用？**
- **作用**：优化碰撞检测性能的算法
- **应用场景**：
  - 大量物体的碰撞检测
  - 性能优化
- **AABB（Axis-Aligned Bounding Box）**
  - **说明**：简单的说是通过物体的矩形（立方体）外框作为碰撞检测判断的过滤方法，这个AABB框没有碰撞，就先不检查物体的细节碰撞
  - **应用**：作为粗检测，提高碰撞检测性能
  - **优点**：计算简单，性能好
  - **缺点**：精度较低

- **其他算法**：
  - **OBB（Oriented Bounding Box）**：有方向的包围盒，精度更高
  - **Sphere**：球形包围体，计算简单
  - **GJK算法**：用于凸体碰撞检测
  - **SAT（Separating Axis Theorem）**：分离轴定理，用于凸体碰撞检测

**会遇到哪些问题？用什么解决？**
- **算法选择**
  - **问题**：如何选择合适的碰撞检测算法
  - **解决方向**：
    - 粗检测使用AABB或Sphere
    - 精确检测使用更复杂的算法
    - 根据精度需求选择
    - 考虑性能开销

- **性能优化**
  - **问题**：碰撞检测算法性能开销大
  - **解决方向**：
    - 使用空间分割（Spatial Partitioning）
    - 使用层次结构（Hierarchical）
    - 使用粗检测过滤
    - 减少不必要的检测

**要点和思考方向**
- AABB是常用的粗检测算法
- 使用粗检测可以大幅提高性能
- 根据精度需求选择合适的算法
- 空间分割可以优化大量物体的碰撞检测
- 理解不同算法的优缺点

## 优化

**是什么？在哪用？**
- **作用**：提高物理模拟的性能和效率
- **应用场景**：
  - 大量物理对象的场景
  - 性能敏感的游戏
  - 移动平台游戏

**会遇到哪些问题？用什么解决？**
- **性能问题**
  - **碰撞模式**
    - **问题**：不同的碰撞模式（CPU）性能差别非常大
    - **解决方向**：
      - 要做好平衡，根据实际需求选择合适的碰撞检测模式
      - 慢速物体使用离散检测
      - 快速物体使用连续检测（但性能开销大）

  - **空间分割**
    - **方法**：预知的不可能相互碰撞的物体置入不同的分组中，碰撞检测时就不用对这两个分组中的物体进行碰撞运算，以节省大量的运算
    - **技术**：
      - **四叉树/八叉树**：空间分割树
      - **网格分割**：将空间划分为网格
      - **BVH（Bounding Volume Hierarchy）**：层次包围盒

  - **选择中间件**
    - **说明**：不同的中间件可能会有不同的硬件加速支持，可以根据产品所运行的平台，游戏的物理内容，来选择适合的中间件来实现物理表现

  - **其他优化方法**
    - **减少物理对象数量**：合并小物体，使用静态碰撞体
    - **物理LOD**：远距离简化物理计算
    - **固定时间步长**：使用固定时间步长提高稳定性
    - **多线程**：使用多线程进行物理计算

**要点和思考方向**
- 物理优化是游戏性能优化的重要方面
- 碰撞检测模式对性能影响很大
- 空间分割可以大幅提高性能
- 选择合适的物理引擎很重要
- 合理使用静态碰撞体可以减少计算量
- 物理LOD可以优化远距离物体

## 物理材质

**是什么？在哪用？**
- **作用**：定义物体的物理属性，影响碰撞和摩擦行为
- **应用场景**：
  - 不同材质的物体（金属、木头、橡胶等）
  - 需要不同物理行为的物体
- **属性**：
  - 摩擦力
  - 弹性系数
  - 密度（影响质量）

## 摩擦力

**是什么？在哪用？**
- **作用**：模拟物体表面的摩擦效果
- **应用场景**：
  - 地面材质（冰面、沙地、普通地面等）
  - 物体材质（金属、橡胶等）
- **静摩擦**：物体静止时的摩擦力
  - **应用**：防止物体滑动
- **动摩擦**：物体运动时的摩擦力
  - **应用**：模拟运动时的阻力

**会遇到哪些问题？用什么解决？**
- **摩擦力设置**
  - **问题**：摩擦力设置不当导致运动不真实
  - **解决方向**：
    - 根据材质特性设置合理的摩擦力
    - 测试和调整
    - 参考真实材质的摩擦系数

**要点和思考方向**
- 摩擦力影响物体的运动
- 静摩擦防止物体滑动
- 动摩擦模拟运动阻力
- 根据材质特性设置合理的摩擦力

## 弹性系数（Bounciness）

**是什么？在哪用？**
- **作用**：决定反弹的"程度"，比如铁球的反弹系数较低，皮球的反弹系数较高
- **应用场景**：
  - 不同材质的物体
  - 需要不同反弹效果的物体
- **范围**：通常0-1，0表示不反弹，1表示完全弹性碰撞

**会遇到哪些问题？用什么解决？**
- **弹性设置**
  - **问题**：弹性系数设置不当导致反弹不真实
  - **解决方向**：
    - 根据材质特性设置合理的弹性系数
    - 避免过大的弹性系数（可能导致不稳定）
    - 测试和调整

- **能量损失**
  - **问题**：完全弹性碰撞（弹性系数1）可能导致能量不损失
  - **解决方向**：
    - 使用小于1的弹性系数
    - 添加阻尼
    - 模拟能量损失

**要点和思考方向**
- 弹性系数决定反弹程度
- 0表示不反弹，1表示完全弹性碰撞
- 根据材质特性设置合理的弹性系数
- 避免过大的弹性系数导致不稳定
- 通常需要能量损失（弹性系数小于1）

## 射线

**是什么？在哪用？**
- **作用**：从起点向指定方向发射一条射线，检测与物体的交点
- **应用场景**：
  - 射击游戏中的射击检测
  - 鼠标点击拾取
  - 视线检测
  - 距离测量
- **特点**：性能好，适合快速检测

## 应用举例

- **射击游戏中的射击目标检测**：检测子弹是否命中目标

- **鼠标、光标在3D场景中的点击拾取**：检测鼠标点击的3D位置

- **视线检测**：检测角色是否能看到目标

- **距离测量**：测量两点之间的距离

**会遇到哪些问题？用什么解决？**
- **射线精度**
  - **问题**：射线可能检测不到小物体或薄物体
  - **解决方向**：
    - 使用更精确的碰撞体
    - 使用多条射线
    - 调整射线起点和方向

- **性能问题**
  - **问题**：大量射线检测可能导致性能问题
  - **解决方向**：
    - 限制射线数量
    - 使用空间分割优化
    - 缓存射线结果
    - 使用粗检测过滤

- **射线过滤**
  - **问题**：射线可能检测到不需要的物体
  - **解决方向**：
    - 使用Layer过滤
    - 使用Tag过滤
    - 使用碰撞组（Collision Group）
    - 手动过滤结果

**要点和思考方向**
- 射线检测性能好，适合快速检测
- 可以用于射击、拾取、视线检测等
- 注意射线精度和过滤
- 合理使用射线可以提高游戏体验
- 大量射线检测需要注意性能

## 阻尼振动

**是什么？在哪用？**
- **作用**：模拟振动系统的衰减，使运动更自然
- **应用场景**：
  - 摄像机跟随
  - UI动画
  - 物体运动
  - 弹簧效果
- **说明**：阻尼振动是指，由于振动系统受到摩擦和介质阻力或其他能耗而使振幅随时间逐渐衰减的振动，又称减幅振动、衰减振动

## 应用举例

- **赛车游戏中的跟随摄像机**
  - **问题**：如果生硬的绑定在车子的后面，会体验会很不好
  - **解决**：如果车子在加速和减速的时候，跟随摄像机有一定加减速和阻尼振动，会让体验更自然

- **UI动画**：按钮点击、菜单弹出等

- **弹簧效果**：物体受力的弹性响应

**会遇到哪些问题？用什么解决？**
- **阻尼参数设置**
  - **问题**：阻尼参数设置不当导致运动不自然
  - **解决方向**：
    - 根据需求调整阻尼系数
    - 测试和调整
    - 使用临界阻尼（Critical Damping）避免振荡

- **性能问题**
  - **问题**：大量阻尼计算可能导致性能问题
  - **解决方向**：
    - 简化阻尼计算
    - 使用预计算
    - 限制阻尼计算频率

**要点和思考方向**
- 阻尼振动使运动更自然
- 阻尼系数影响衰减速度
- 临界阻尼可以避免振荡
- 合理使用阻尼可以提高游戏体验
- 注意阻尼计算的性能开销

## 约束

**是什么？在哪用？**
- **作用**：将多个物体（刚体）连接在一起，限制它们的相对运动
- **应用场景**：
  - 关节系统（角色骨骼、机械关节等）
  - 机械连接
  - 绳索、链条等
- **特性**：有的物理引擎中，超过一定的力，可以破坏掉约束

## 应用

- **关节的效果**：模拟人体关节、机械关节等
  - **铰链关节（Hinge Joint）**：单轴旋转
  - **球关节（Ball Joint）**：多轴旋转
  - **固定关节（Fixed Joint）**：固定连接

- **机械的衔接部件**：模拟机械连接

- **绳索和链条**：模拟柔性连接

**会遇到哪些问题？用什么解决？**
- **约束不稳定**
  - **问题**：约束可能出现抖动、不稳定
  - **解决方向**：
    - 调整约束参数
    - 使用更稳定的约束算法
    - 限制约束力
    - 使用固定时间步长

- **性能问题**
  - **问题**：大量约束导致性能问题
  - **解决方向**：
    - 限制约束数量
    - 简化约束计算
    - 使用约束LOD
    - 优化约束求解器

- **约束破坏**
  - **问题**：约束可能被意外破坏
  - **解决方向**：
    - 设置合理的破坏阈值
    - 监控约束状态
    - 处理约束破坏事件

**要点和思考方向**
- 约束用于连接多个刚体
- 不同类型的约束有不同的应用场景
- 约束可能不稳定，需要调整参数
- 注意约束的性能开销
- 合理使用约束可以实现复杂的物理效果

## 软体

**是什么？在哪用？**
- **作用**：模拟可变形物体的物理行为
- **应用场景**：
  - 绳子、链条
  - 布料、旗帜
  - 软体生物（虫子、果冻等）
  - 流体效果
- **特点**：可以变形，不像刚体那样保持形状

## 应用举例

- **在游戏中实现类似绳子、虫子、果冻等物体的效果**

- **布料模拟**：角色服装、旗帜等

- **流体效果**：水、液体等

**会遇到哪些问题？用什么解决？**
- **性能问题**
  - **问题**：软体计算开销大，性能影响明显
  - **解决方向**：
    - 限制软体数量
    - 简化软体模型
    - 使用软体LOD
    - 优化软体算法

- **稳定性问题**
  - **问题**：软体可能出现抖动、不稳定
  - **解决方向**：
    - 调整软体参数
    - 使用更稳定的算法
    - 限制软体变形程度
    - 使用固定时间步长

- **精度问题**
  - **问题**：软体模拟精度与性能的平衡
  - **解决方向**：
    - 根据需求调整精度
    - 使用简化模型
    - 使用预计算

**要点和思考方向**
- 软体可以模拟可变形物体
- 软体计算开销大，需要谨慎使用
- 根据需求选择合适的软体算法
- 注意软体的稳定性和性能
- 软体可以增强游戏的视觉效果

## 候选中间件

**是什么？在哪用？**
- **作用**：提供物理模拟功能的第三方库
- **应用场景**：
  - 游戏物理模拟
  - 物理交互
  - 碰撞检测
- **说明**：游戏引擎通常集成物理引擎，也可以单独使用

## Physx

**是什么？在哪用？**
- **作用**：NVIDIA开发的物理引擎
- **应用场景**：
  - 支持NVIDIA GPU加速的平台
  - 需要高性能物理模拟的游戏
- **优势**：
  - 在一些设备上有硬件加速
  - 性能好
  - 功能完善
- **平台**：PC、游戏机等

**要点和思考方向**
- Physx在支持GPU加速的设备上性能好
- 适合需要高性能物理模拟的游戏
- 主要在NVIDIA平台上使用

## Bullet

**是什么？在哪用？**
- **作用**：开源的物理引擎
- **应用场景**：
  - 需要免费物理引擎的项目
  - 跨平台项目
- **优势**：
  - 免费
  - 开源
  - 跨平台
  - 功能完善
- **平台**：PC、移动平台等

**要点和思考方向**
- Bullet是免费开源的物理引擎
- 适合需要免费解决方案的项目
- 跨平台支持好

## Havok

**是什么？在哪用？**
- **作用**：商业物理引擎
- **应用场景**：
  - 大型商业游戏
  - 需要完善支持的项目
- **优势**：
  - 比较完善的商业物理引擎
  - 功能强大
  - 技术支持好
- **平台**：PC、游戏机等

**要点和思考方向**
- Havok是商业物理引擎
- 适合大型商业项目
- 功能完善，技术支持好

**会遇到哪些问题？用什么解决？**
- **中间件选择**
  - **问题**：不同中间件有不同的特点和适用场景
  - **解决方向**：
    - 根据项目需求、目标平台、性能要求、成本等因素选择合适的物理引擎
    - 考虑硬件加速支持
    - 考虑许可证和成本
    - 考虑功能需求
    - 考虑平台支持

- **集成问题**
  - **问题**：物理引擎集成可能遇到问题
  - **解决方向**：
    - 使用游戏引擎集成的物理引擎（推荐）
    - 参考文档和示例
    - 使用社区支持

**要点和思考方向**
- 选择合适的物理引擎很重要
- 考虑性能、功能、成本等因素
- 游戏引擎通常已集成物理引擎
- 根据项目需求选择合适的物理引擎
- 了解各物理引擎的特点和适用场景

## 更多资料

## 讲义资料
* [Physically Based Modeling: Principles and Practice](https://www.cs.cmu.edu/~baraff/sigcourse/)

## 论文资料
* [Advanced Character Physics](https://www.cs.cmu.edu/afs/cs/academic/class/15462-s13/www/lec_slides/Jakobsen.pdf)

## 在线文章
* [Game Physics: Broadphase – Dynamic AABB Tree](https://allenchou.net/2014/02/game-physics-broadphase-dynamic-aabb-tree/) - 本文解释了动态 AABB 树的工作原理，并展示了示例实现。

## 视频资料
* [Building a Physics Engine with C++ and Simulating Machines](https://www.youtube.com/watch?v=TtgS-b191V0)
* [Let's talk about physics engines in games](https://www.youtube.com/watch?v=obGMhUvq5pg)
