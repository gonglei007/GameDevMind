<h2 align="center">数据库</h2>
<p>
当前游戏开发所用数据库的常用类型就是：缓存类的和非缓存类的，关系型的和非关系型的。什么情况下用哪种数据库呢？使用数据库的时候会有哪些问题呢？
</p>

**关键词:**<br/>
*数据库,SQL,MongoDB,Redis,缓存数据库,关系数据库,连接池,读写分离,事务*

----
## 通用考虑

### CRUD（增删改查）

### 是什么？在哪用？

- **作用**：数据库的基本操作，创建（Create）、读取（Read）、更新（Update）、删除（Delete）

### 设计考虑

### 会遇到哪些问题？

- **异步处理**
  - **问题**：数据库都是通过网络进行IO操作，所以都是异步处理。这样在使用的时候就要考虑操作的并发和异步问题
  - **解决方向**：合理设计异步操作流程，处理并发访问

### 维护考虑

### 是什么？在哪用？

- **数据回滚**：在出现错误时能够回滚到之前的状态

- **备份与恢复**：定期备份数据，确保数据安全

### 并发问题

### 会遇到哪些问题？

### 更新丢失

- **情景**：
  - B读取数据
  - A读取数据
  - A回写数据
  - B回写数据
- **结果**：A的回写就丢了

### 错误求和

- **情景**：
  - A先读取一个数据
  - B改写了下一个数据
  - A读取了这个改写后的数据
- **结果**：A在求和的时候一部分是老数据、一部分是新数据

### 重复读取

- **情景**：
  - A先读取一个数据
  - B改了这个数据
  - A再读这个数据
- **结果**：A在两次使用一个数据的时候不一致了

### 解决

- **事务排队处理**：一个完成了再做下一个

### 集群

### 是什么？在哪用？

- **作用**：通过集群提高数据库的可用性和性能

## 关系数据库

### 是什么？在哪用？

### SQL语言

### 数据表

- **主键**：唯一标识表中的每一行
- **索引**：提高查询性能

### 查询

- **select from**：从哪里查询
- **order by**：按什么排序
- **where**：什么查询条件
- **as**：别名
- **group by**：基于什么分组
- **join**：联合查询

### 存储过程

### 是什么？在哪用？

- **作用**：
  - 通常是在应用端通过sql语句来操作数据，如果要执行一段业务逻辑，这样来来回回的发语句、执行、返回结果，效率会比较低
  - 存储过程是在数据库的后端执行代码，直接发送一个指令（过程名）和参数到数据库后端，之后由数据库后端来执行这段代码

- **应用场景**：如果业务逻辑比较封闭、sql操作比较多，就可以考虑建立一个存储过程

### 事务

### 是什么？在哪用？

- **作用**：保证一系列操作的原子性，要么全部成功，要么全部失败

### SQL优化

### 会遇到哪些问题？用什么解决？

- **性能问题**
  - **问题**：SQL查询可能性能不佳
  - **解决方向**：优化SQL语句，使用索引，分析执行计划

### 候选

### 是什么？在哪用？

- **MySQL**：开源的关系型数据库
- **MSSQL**：微软的关系型数据库

### 应用

### 是什么？在哪用？

- **支撑平台服务场景**：
  - 账户数据
  - 支付数据
  - 统计数据

- **后台运营场景**：运营后台的数据管理

## MongoDB

### 是什么？在哪用？

### 特性

- **非关系型数据库/文档数据库**：以文档形式存储数据
- **数据操作灵活**：不需要固定的表结构

### 应用

### 是什么？在哪用？

- **游戏服场景**：游戏内的数据，比如角色/玩家在游戏内的数据

### 考虑问题

### 会遇到哪些问题？用什么解决？

- **Schema更新问题**
  - **问题**：当Schema更新了，玩家数据要如何更新？
  - **解决方向**：实现一个mongoose的upsert扩展插件，遍历数据key，按新的数据结构补齐并更新文档。细节查看markdowns文档中的更多资料

## 缓存数据库

### 是什么？在哪用？

### 作用

- **其它数据区是从文件访问数据，虽然也有一定的缓存规则，但速度还是很慢。有了缓存数据库，直接将数据放到内存进行操作访问，处理速度就会快很多**
- **用于数据的频繁、快速访问**

### 应用

### 是什么？在哪用？

- **游戏服场景**：需要快速访问的游戏数据

### 候选

### 是什么？在哪用？

- **Redis**
  - **特性**：
    - 单线程响应
    - 网络 I/O 多路复用
    - 非阻塞的执行方式

### 功能

### 是什么？在哪用？

- **缓存过期**：设置缓存数据的过期时间

### 解决问题

### 会遇到哪些问题？用什么解决？

- **持久化**
  - **问题**：由于缓存数据库都是存储在内存中，所以要考虑这些数据的持久化方法，防止数据丢失
  - **解决方向**：配置持久化策略，选择合适的持久化时机

- **异常处理**：处理缓存数据库的异常情况

### 性能问题

### 会遇到哪些问题？用什么解决？

- **算法复杂度**
  - **问题**：注意查看每种数据结构的操作算法复杂度
  - **解决方向**：选择合适的数据结构，了解其性能特征

- **单线程限制**
  - **问题**：因为是单线程，一个Redis进程主要占用一个CPU内核
  - **解决方向**：如果在同一台主机想要获得更大的处理能力，可以考虑使用多个Redis进程

## 性能与优化

### 是什么？在哪用？

### 连接池

### 会遇到哪些问题？用什么解决？

- **游戏中会频繁的访问操作数据，如何合理的建立数据库链接？**
  - **注意**：
    - **数量不要太少**：太少解决不了数据访问拥挤、阻塞的问题
    - **数量也不要太多**：太多了访问量上来了会把系统资源占满，影响其它业务

### 读写分离

### 是什么？在哪用？

- **作用**：可以有效提高数据库系统的性能、可用性、容错性和负载均衡能力
- **应用**：将读操作和写操作分离到不同的数据库实例

## 更多资料

### 在线文章
* [MongoDB 全方位知识图谱](https://zhuanlan.zhihu.com/p/497736109) - 本文既有 MongoDB 基础知识也有相对深入的进阶知识，同时适用于对 MonogDB 感兴趣的初学者或者希望对 MongoDB 有更深入了解的业务开发者。
* [面试官：你确定 Redis 是单线程的进程吗？](https://www.51cto.com/article/714246.html)
* [Redis 是单线程的正确理解](https://www.jianshu.com/p/bc6904abc330)

### 视频资料
* [8 Key Data Structures That Power Modern Databases](https://www.youtube.com/watch?v=W_v05d_2RTo)

### 问答资料
* [How do I update/upsert a document in Mongoose?](https://stackoverflow.com/questions/7267102/how-do-i-update-upsert-a-document-in-mongoose/50208331#50208331) (问答)
* [Redis 在使用中会遇到哪些坑？如何规避？](https://www.zhihu.com/question/57045322/answer/1931497548)
