<h2 align="center">产品热更新</h2>
<p>跟热更新相关的技术和应用。</p>

**关键词:**<br/> 
*热更新,hotfix,lua,CDN*

**标签:**<br/>
*等级: 中级, 阶段: 开发|运营, 分类: 运营能力, 角色: 客户端开发|服务端开发|运维*

## 图谱
![图片加载中...](../../exports/6.2.3.产品热更新.png?raw=true)

## 子主题

### 为什么需要热更新？

**会遇到哪些问题？**

- **网游产品的一大要求——能应对快速变化**：策划不停更新游戏内容（活动礼包等等）
  - 每次针对修改去定制，耗时耗力
  - 每次出版本更新，对于网游运营应对太慢

**是做什么的？在哪用？**

- **应用场景**：
  - 内容和功能的更新
  - 调整策划数据
  - 修复产品bug
- **运营需求**：
  - 数据表热更
  - 资源+代码热更

**要点和思考方向**

- 热更新是网游产品快速迭代的基础能力
- 可以避免频繁发版导致的用户流失
- 需要支持差异化更新，不同渠道、版本可能需要不同的热更内容

### 热更新系统需要具备的功能

**是做什么的？在哪用？**

- **要能差异化更新**：支持不同渠道、版本的热更内容
- **要能快速的制作和发布**：提升运营效率
- **游戏用户不用下载安装新包，造成流失**：通过热更避免用户流失
- **一键生成可热更数据**：简化数据制作流程
- **一键发布数据**：
  - 自动上传、预热
- **可快速切换版本**：支持版本回滚
- **版本管理**：
  - 坐标：环境、平台、分支等

**要点和思考方向**

- 热更新系统要易用，降低运营成本
- 版本管理要灵活，支持多环境、多平台、多分支
- 需要支持快速回滚，应对线上问题

### 客户端方案

**是做什么的？在哪用？**

- **作用**：在客户端实现热更新功能，支持动态加载资源和代码
- **应用场景**：游戏客户端需要支持热更新

**会遇到哪些问题？用什么解决？**

- **代码/脚本数据化方案**：
  - **问题**：原生代码无法热更新
  - **解决方案**：
    - **Lua**：使用脚本语言实现热更新
      - **候选**：tolua、xlua
    - **C#脚本**：预先插入注入代码
    - **C#**：使用ILRuntime或HybridCLR实现C#热更新
      - **候选**：HybridCLR、ILRuntime
- **客户端运行时系统功能**：
  - 指向更新后台
  - 检查版本
  - 获取资源清单
  - 比较资源hash值
  - 同步/下载变化的资源
    - **注意**：不能直接下载覆盖原来的文件
  - 更新时机：
    - 启动时检查更新
    - 后台静默更新
- **关联系统**：
  - **依赖系统**：
    - HTTP网络系统（多线程并行下载）
    - 考虑问题：网络下载异常处理
  - **对接系统**：
    - UI系统
    - 元数据系统
    - Lua系统或者其它动态脚本系统

**要点和思考方向**

- 客户端热更新需要支持资源更新和代码更新
- 脚本语言（如Lua）是常见的代码热更新方案
- 资源更新要支持差异更新，避免下载完整资源包
- 需要考虑网络异常、下载失败等异常情况
- 更新时机要合理，避免影响用户体验

### 服务端方案

**是做什么的？在哪用？**

- **作用**：服务端热更新配置数据，支持动态调整游戏配置
- **应用场景**：服务端需要支持配置数据热更新

**会遇到哪些问题？用什么解决？**

- **说明**：服务端通常不需要跟客户端共用艺术数据和代码，但通常会共用配置数据
- **服务端运行时系统功能**：
  - 由于服务端跟客户端使用数据的特性不同，服务端可以选择（配置）数据包整体下载、释放
- **考虑问题**：
  - 数据更新后，内存中的元数据（被使用和引用的）和由元数据衍生出来的数据需要更新

**要点和思考方向**

- 服务端热更新主要是配置数据更新
- 需要考虑数据更新后内存数据的同步更新
- 服务端数据更新要保证数据一致性

### 数据生产方案

**是做什么的？在哪用？**

- **作用**：将策划、美术、程序的数据转换为游戏中可使用的格式
- **应用场景**：热更新数据制作流程

**会遇到哪些问题？用什么解决？**

- **配置数据（策划）**：
  - 生成在游戏中可使用的配置数据
  - 处理：Excel转json、xml等
- **艺术和场景数据（美术）**：
  - 可在游戏中加载使用
  - 处理：直接生成bundle
- **代码数据（程序）**：
  - 处理：脚本编码加固（可选）

**要点和思考方向**

- 数据生产要自动化，支持一键生成
- 不同来源的数据需要不同的处理方式
- 代码数据可以考虑加密加固，保护知识产权

### 数据发布方案

**是做什么的？在哪用？**

- **作用**：将热更新数据发布到CDN，供客户端下载
- **应用场景**：热更新数据发布流程

**会遇到哪些问题？用什么解决？**

- **数据更新方式**：
  - **增量包更新**：过去端游用的多些
  - **差异更新**：这是我们所采用的（只更新变化的部分）
- **数据加速**：
  - 用CDN对数据加速
  - 刷新预热：新上传的数据要预热，更新的文件要刷新

**要点和思考方向**

- 差异更新可以大大减少下载量，提升更新速度
- CDN加速可以提升下载速度，改善用户体验
- 需要支持预热和刷新，确保用户能获取到最新数据

### 管理后台方案

**是做什么的？在哪用？**

- **作用**：管理热更新版本，支持版本发布和回滚
- **应用场景**：热更新版本管理

**会遇到哪些问题？用什么解决？**

- **功能**：
  - **版本发布**：发布新的热更新版本
  - **版本回滚**：
    - **解决问题**：如果发现一个版本有问题，要能回退到之前的版本
  - **配置**：配置热更新相关参数

**要点和思考方向**

- 管理后台要简单易用，支持快速发布和回滚
- 版本回滚是重要的安全机制，必须支持
- 需要支持版本配置，如环境、平台、分支等

### 版本管理

**会遇到哪些问题？用什么解决？**

- **问题**：上线的产品可能版本众多，要能够有效的规划版本和分支
- **解决方案**：
  - **维度**：
    - 版本
    - 渠道
  - **分支**：
    - 可以为渠道创建版本控制分支，内容一致的渠道在一个分支上
    - 设定分热修复分支，用于日常快速修复线上问题
    - **分支合并**：在热更分支修复，合并回开发分支

**要点和思考方向**

- 版本管理要支持多维度（版本、渠道、分支）
- 热修复分支可以快速修复线上问题，不影响主分支
- 分支合并要保持代码一致性

### 热更发布流程

**是做什么的？在哪用？**

- **作用**：规范热更新发布流程，确保发布质量
- **应用场景**：日常热更新发布

**会遇到哪些问题？用什么解决？**

- **流程**：
  1. **准备**：准备热更测试环境
  2. **制作**：制作热更数据
  3. **发布**：发布热更数据
  4. **测试**：
     - 在测试环境（后台）应用这个版本
     - 用测试包进行测试
  5. **应用**：在正式服应用热更版本

**要点和思考方向**

- 热更发布要有规范的流程，确保质量
- 测试环节很重要，避免问题版本上线
- 需要支持测试环境和正式环境的切换

### 大版本发布

**会遇到哪些问题？用什么解决？**

- **问题**：大版本更新时，老版本客户端可能不兼容新热更
- **解决方案**：
  - **如果老版本客户端兼容新热更**：则直接制作、发布、应用最新内容的热更
  - **如果老版本客户端不兼容新热更**：则只针对最新的包开启热更检查。并在合适的时机开启包更新提醒，比如3天内非强制更新提醒，3天后强制更新提醒

**要点和思考方向**

- 大版本发布要考虑老版本兼容性
- 需要制定合理的更新策略，平衡用户体验和版本统一
- 强制更新要谨慎，避免用户流失
