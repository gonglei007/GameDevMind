name: Generate Index

on:
  push:
    branches: [ main ]
    paths:
      - 'mds/**'
      - '.github/workflows/generate-index.yml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-index:
    name: Generate Documentation Index
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Generate index
        run: |
          echo "ç”Ÿæˆæ–‡æ¡£ç´¢å¼•..."
          
          # åˆ›å»ºç´¢å¼•æ–‡ä»¶å¤´éƒ¨
          cat > INDEX_NEW.md << 'EOF'
          # GameDevMind æ–‡æ¡£ç´¢å¼•
          
          > å¿«é€Ÿå¯¼èˆªåˆ°æ‰€æœ‰æ–‡æ¡£
          
          > **æ³¨æ„**: æ­¤æ–‡ä»¶ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆï¼Œè¯·å‹¿æ‰‹åŠ¨ç¼–è¾‘
          
          ## ðŸ“š æŒ‰èƒ½åŠ›æ¨¡å—åˆ†ç±»
          EOF
          
          # æ‰«æä¸»è¦èƒ½åŠ›æ¨¡å—ç›®å½• (1-6)
          for i in 1 2 3 4 5 6; do
            if [ -d "mds/$i."* ]; then
              module_dir=$(find mds -maxdepth 1 -type d -name "$i.*" | head -1)
              if [ -n "$module_dir" ]; then
                module_name=$(basename "$module_dir")
                module_title=$(echo "$module_name" | sed 's/^[0-9]*\.//')
                
                # æ·»åŠ æ¨¡å—æ ‡é¢˜
                echo "" >> INDEX_NEW.md
                echo "### $i. $module_title" >> INDEX_NEW.md
                echo "" >> INDEX_NEW.md
                
                # æ·»åŠ ä¸»æ¨¡å—æ–‡ä»¶
                if [ -f "$module_dir/$module_name.md" ]; then
                  echo "- [$module_title]($module_dir/$module_name.md)" >> INDEX_NEW.md
                  echo "" >> INDEX_NEW.md
                fi
                
                # æ·»åŠ å­ç›®å½•å’Œæ–‡ä»¶
                find "$module_dir" -mindepth 1 -maxdepth 1 -type d | sort | while read subdir; do
                  subdir_name=$(basename "$subdir")
                  if [ -f "$subdir/$subdir_name.md" ]; then
                    subdir_title=$(echo "$subdir_name" | sed 's/^[0-9]*\.//')
                    echo "  - [$subdir_title]($subdir/$subdir_name.md)" >> INDEX_NEW.md
                    
                    # æ·»åŠ å­ç›®å½•ä¸‹çš„æ–‡ä»¶
                    find "$subdir" -mindepth 1 -maxdepth 1 -type f -name "*.md" ! -name "$subdir_name.md" | sort | while read file; do
                      file_name=$(basename "$file" .md)
                      file_title=$(echo "$file_name" | sed 's/^[0-9]*\.//')
                      echo "    - [$file_title]($file)" >> INDEX_NEW.md
                    done
                  fi
                done
                
                # æ·»åŠ æ¨¡å—ç›®å½•ä¸‹çš„ç›´æŽ¥æ–‡ä»¶
                find "$module_dir" -maxdepth 1 -type f -name "*.md" ! -name "$module_name.md" | sort | while read file; do
                  file_name=$(basename "$file" .md)
                  file_title=$(echo "$file_name" | sed 's/^[0-9]*\.//')
                  echo "  - [$file_title]($file)" >> INDEX_NEW.md
                done
              fi
            fi
          done
          
          # æ·»åŠ ä¸“é¢˜å†…å®¹
          echo "" >> INDEX_NEW.md
          echo "## ðŸ“– ä¸“é¢˜å†…å®¹" >> INDEX_NEW.md
          echo "" >> INDEX_NEW.md
          
          if [ -d "mds/ä¸€ç«™å¼æ‰‹æ¸¸åˆ›ä¸š" ]; then
            echo "### ä¸€ç«™å¼æ‰‹æ¸¸åˆ›ä¸š" >> INDEX_NEW.md
            echo "" >> INDEX_NEW.md
            find mds/ä¸€ç«™å¼æ‰‹æ¸¸åˆ›ä¸š -name "*.md" -type f | sort | while read file; do
              file_name=$(basename "$file" .md)
              echo "- [$file_name]($file)" >> INDEX_NEW.md
            done
            echo "" >> INDEX_NEW.md
          fi
          
          # æ·»åŠ å…¶ä»–ä¸“é¢˜
          echo "### å…¶ä»–ä¸“é¢˜" >> INDEX_NEW.md
          echo "" >> INDEX_NEW.md
          find mds -maxdepth 1 -name "*.md" -type f ! -name "README.md" | sort | while read file; do
            file_name=$(basename "$file" .md)
            echo "- [$file_name]($file)" >> INDEX_NEW.md
          done
          
          # æ·»åŠ  topics
          if [ -d "mds/topics" ]; then
            echo "" >> INDEX_NEW.md
            echo "### Topics" >> INDEX_NEW.md
            echo "" >> INDEX_NEW.md
            find mds/topics -name "*.md" -type f | sort | while read file; do
              file_name=$(basename "$file" .md)
              echo "- [$file_name]($file)" >> INDEX_NEW.md
            done
          fi
          
          # æ·»åŠ ç»Ÿè®¡ä¿¡æ¯
          echo "" >> INDEX_NEW.md
          echo "## ðŸ“Š ç»Ÿè®¡ä¿¡æ¯" >> INDEX_NEW.md
          echo "" >> INDEX_NEW.md
          doc_count=$(find mds -name "*.md" -type f | wc -l)
          echo "- **æ€»æ–‡æ¡£æ•°**: $doc_count" >> INDEX_NEW.md
          echo "- **æœ€åŽæ›´æ–°**: $(date '+%Y-%m-%d %H:%M:%S')" >> INDEX_NEW.md
          echo "" >> INDEX_NEW.md
          
          # æ·»åŠ ä½¿ç”¨å»ºè®®
          echo "## ðŸ’¡ ä½¿ç”¨å»ºè®®" >> INDEX_NEW.md
          echo "" >> INDEX_NEW.md
          echo "1. **æ–°æ‰‹å…¥é—¨**: ä»Ž\"åŸºç¡€èƒ½åŠ›\"æ¨¡å—å¼€å§‹" >> INDEX_NEW.md
          echo "2. **æŠ€æœ¯å­¦ä¹ **: æŒ‰\"æŠ€æœ¯èƒ½åŠ›\"â†’\"ç ”å‘èƒ½åŠ›\"â†’\"ç”Ÿäº§èƒ½åŠ›\"é¡ºåº" >> INDEX_NEW.md
          echo "3. **é¡¹ç›®ç®¡ç†**: é‡ç‚¹å…³æ³¨\"ç®¡ç†èƒ½åŠ›\"å’Œ\"è¿è¥èƒ½åŠ›\"" >> INDEX_NEW.md
          echo "4. **åˆ›ä¸šå‚è€ƒ**: æŸ¥çœ‹\"ä¸€ç«™å¼æ‰‹æ¸¸åˆ›ä¸š\"ä¸“é¢˜" >> INDEX_NEW.md
          echo "" >> INDEX_NEW.md
          echo "---" >> INDEX_NEW.md
          echo "" >> INDEX_NEW.md
          echo "*æ­¤ç´¢å¼•ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ*" >> INDEX_NEW.md

      - name: Compare and update index
        run: |
          if [ -f "INDEX.md" ]; then
            if ! diff -q INDEX.md INDEX_NEW.md > /dev/null; then
              echo "ç´¢å¼•æ–‡ä»¶æœ‰æ›´æ–°ï¼Œæ­£åœ¨æäº¤..."
              mv INDEX_NEW.md INDEX.md
              
              git config --global user.name "github-actions[bot]"
              git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
              git add INDEX.md
              git commit -m "docs: è‡ªåŠ¨æ›´æ–°æ–‡æ¡£ç´¢å¼• [skip ci]" || echo "No changes to commit"
              git push
            else
              echo "ç´¢å¼•æ–‡ä»¶æ— å˜åŒ–"
              rm INDEX_NEW.md
            fi
          else
            echo "åˆ›å»ºæ–°çš„ç´¢å¼•æ–‡ä»¶..."
            mv INDEX_NEW.md INDEX.md
            git config --global user.name "github-actions[bot]"
            git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add INDEX.md
            git commit -m "docs: è‡ªåŠ¨ç”Ÿæˆæ–‡æ¡£ç´¢å¼• [skip ci]"
            git push
          fi

      - name: Summary
        run: |
          echo "## ç´¢å¼•ç”Ÿæˆå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "å·²è‡ªåŠ¨ç”Ÿæˆ/æ›´æ–°æ–‡æ¡£ç´¢å¼•" >> $GITHUB_STEP_SUMMARY

